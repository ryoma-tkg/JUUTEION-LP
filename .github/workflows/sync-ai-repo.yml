name: Sync to AI Branch

# dev-test ブランチへの Push で発動
on:
  push:
    branches:
      - dev-test

# GITHUB_TOKEN に書き込み権限を与える
permissions:
  contents: write

jobs:
  sync-branch:
    runs-on: ubuntu-latest
    steps:
      # 1. 現在のコード (dev-test) を取得
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 全履歴を取得（ブランチ切り替えのため）

      # 2. AIに読ませたいファイルだけを一時フォルダに退避
      - name: Filter Files
        run: |
          mkdir -p /tmp/ai-ready
          
          # rsyncで必要なファイルだけを /tmp/ai-ready にコピー
          rsync -av \
            --include='src/***' \
            --include='public/' \
            --include='public/favicon.svg' \
            --exclude='public/images/*' \
            --exclude='public/fonts/*' \
            --include='package.json' \
            --include='astro.config.mjs' \
            --include='tailwind.config.mjs' \
            --include='tsconfig.json' \
            --include='README.md' \
            --include='roadmap.md' \
            --exclude='*' \
            ./ /tmp/ai-ready/

      # 3. ai-chat ブランチに切り替えて、中身を入れ替える
      - name: Deploy to ai-chat branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # ai-chat ブランチを作成（またはリセット）して切り替え
          # --orphan を使うことで、過去の履歴と切り離した綺麗なブランチにします
          git checkout --orphan ai-chat
          
          # 現在のブランチの中身を一旦全部消す（.git以外）
          git rm -rf .

          # 退避しておいた選別済みファイルを書き戻す
          rsync -av /tmp/ai-ready/ ./

          # コミット
          git add .
          git commit -m "AI用同期: ${{ github.event.head_commit.message }}"

          # リモートの ai-chat ブランチへ強制上書き (Force Push)
          git push origin ai-chat --force