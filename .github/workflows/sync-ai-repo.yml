name: Sync to AI Branch

on:
  push:
    branches:
      - dev-test

permissions:
  contents: write

jobs:
  sync-branch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Filter Files (Copy & Clean approach)
        run: |
          # 1. 一時フォルダを作成
          mkdir -p /tmp/ai-ready

          # 2. プロジェクト全体を一旦コピー (juuteion-hub)
          cp -R juuteion-hub /tmp/ai-ready/

          # 3. 【追加】ルートにあるドキュメント系ファイルをコピー
          # (存在しなくてもエラーで止まらないように || true を付けています)
          cp README.md /tmp/ai-ready/ 2>/dev/null || true
          cp roadmap.md /tmp/ai-ready/ 2>/dev/null || true
          cp readmedev.md /tmp/ai-ready/ 2>/dev/null || true
          cp READNEdev.md /tmp/ai-ready/ 2>/dev/null || true

          # 4. ノイズ除去 (juuteion-hubの中身を掃除)
          cd /tmp/ai-ready/juuteion-hub

          # node_modules や lockファイル削除
          rm -rf node_modules
          rm -rf .astro
          rm -rf dist
          rm -f package-lock.json
          rm -f functions/package-lock.json  # ← ここに追加しました
          rm -f bun.lockb
          rm -f yarn.lock
          rm -f pnpm-lock.yaml
          
          # 重いアセットファイルを除去（画像・フォント）
          rm -rf public/images/*
          rm -rf public/fonts/*
          rm -rf src/assets/*.{jpg,png,webp,avif}
          
          # 不要な設定・隠しファイル
          rm -rf .vscode
          rm -rf .DS_Store

      - name: Deploy to ai-chat branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # ai-chat ブランチを空の状態から作成（履歴切り離し）
          git checkout --orphan ai-chat
          
          # 現在のブランチの中身を全削除
          git rm -rf .

          # 選別済みのファイルを書き戻す
          cp -R /tmp/ai-ready/* .

          # コミット＆強制プッシュ
          git add .
          git commit -m "A- (juuteion-hub + docs): ${{ github.event.head_commit.message }}"
          git push origin ai-chat --force