name: Sync to AI Branch

on:
  push:
    branches:
      - dev-test

permissions:
  contents: write

jobs:
  sync-branch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Filter Files (Copy & Clean approach)
        run: |
          # 1. 一時フォルダを作成
          mkdir -p /tmp/ai-ready

          # 2. プロジェクト全体を一旦コピー (juuteion-hub と README)
          # ※ .git などの隠しファイルは除外されます
          cp -R juuteion-hub /tmp/ai-ready/
          cp README.md /tmp/ai-ready/ 2>/dev/null || true

          # 3. 【ここ重要】AIにとって「不要なファイル」だけをピンポイントで削除
          # これなら必要なコード（src等）は確実に残ります
          cd /tmp/ai-ready/juuteion-hub

          # ノイズ除去リスト
          rm -rf node_modules
          rm -rf .astro
          rm -rf dist
          rm -f package-lock.json
          rm -f bun.lockb
          rm -f yarn.lock
          rm -f pnpm-lock.yaml
          
          # 容量を食うアセットファイルを除去（画像・フォント）
          # ※ favicon.svg だけは軽いので残したい場合を考慮して images/fonts の中身を消す
          rm -rf public/images/*
          rm -rf public/fonts/*
          rm -rf src/assets/*.{jpg,png,webp,avif} # src内の重い画像もカット
          
          # .vscode設定などはAIには不要なので削除
          rm -rf .vscode
          rm -rf .DS_Store

      - name: Deploy to ai-chat branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # ai-chat ブランチを空の状態から作成（履歴を切り離す）
          git checkout --orphan ai-chat
          
          # 現在のブランチの中身を全削除
          git rm -rf .

          # 選別済みのファイルを書き戻す
          cp -R /tmp/ai-ready/* .

          # コミット＆強制プッシュ
          git add .
          git commit -m "A- (juuteion-hub): ${{ github.event.head_commit.message }}"
          git push origin ai-chat --force