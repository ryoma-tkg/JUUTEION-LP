name: Sync to AI Read Repo

# dev-test ブランチに push された時だけ動きます
on:
  push:
    branches:
      - dev-test

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      # 1. 開発用リポジトリ（ソース）を取得
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          path: source-repo

      # 2. AI用リポジトリ（ターゲット）を取得
      # ここでトークンエラーが出ていたので、with: token: ... が正しく機能する必要があります
      - name: Checkout Target
        uses: actions/checkout@v4
        with:
          repository: ryoma-tkg/juuteion-lp-ai-read  # 【重要】コピー先リポジトリ名
          token: ${{ secrets.API_TOKEN_GITHUB }}       # ステップ2で登録したSecret
          path: target-repo
          fetch-depth: 0 # 全履歴を取得（push時のエラー防止）

      # 3. 必要なファイルだけを選別してコピー
      - name: Sync Files
        run: |
          # コピー先の不要ファイルを削除（.git以外）
          find target-repo -maxdepth 1 -not -name '.git' -not -name '.' -not -name '..' -exec rm -rf {} +

          # rsyncで転送（設定ファイル、src、publicの一部のみ）
          rsync -av \
            --include='src/***' \
            --include='public/' \
            --include='public/favicon.svg' \
            --exclude='public/images/*' \
            --exclude='public/fonts/*' \
            --include='package.json' \
            --include='astro.config.mjs' \
            --include='tailwind.config.mjs' \
            --include='tsconfig.json' \
            --include='README.md' \
            --include='roadmap.md' \
            --exclude='*' \
            ./source-repo/ ./target-repo/

      # 4. コミットしてPush
      - name: Commit and Push
        run: |
          cd target-repo
          git config user.name "AI Sync Bot"
          git config user.email "bot@example.com"

          # 変更があるか確認
          if [ -n "$(git status --porcelain)" ]; then
            git add .
            git commit -m "Sync from dev-test: ${{ github.event.head_commit.message }}"
            
            # ai-chatブランチへ強制的に送る（ブランチがなければ作る）
            git checkout -B ai-chat
            git push origin ai-chat
          else
            echo "No changes to sync."
          fi