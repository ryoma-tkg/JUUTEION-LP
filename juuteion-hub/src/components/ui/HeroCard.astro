---
import type { ImageMetadata } from "astro";
import { getImage } from "astro:assets";
import logo from "../../assets/logo/jto_logo.svg";

interface Props {
    title: string;
    subTitle: string;
    date: string;
    time: string;
    place: string;
    price: string;
    image: ImageMetadata | string | null | undefined;
    href?: string;
    mode?: "normal" | "compact";
    // ▼ 追加: 画像の表示位置 (デフォルトは center)
    imagePosition?: string;
}

const {
    title,
    subTitle,
    date,
    time,
    place,
    price,
    image,
    href,
    mode = "normal",
    // ▼ 追加
    imagePosition = "center",
} = Astro.props;

const Tag = href ? "a" : "div";

let bgUrl = "";
let isLogo = false;

// 画像判定ロジック
if (!image) {
    bgUrl = logo.src;
    isLogo = true;
} else if (typeof image === "string") {
    bgUrl = image;
    if (bgUrl.includes("jto_logo.svg")) isLogo = true;
} else if (typeof image === "object") {
    try {
        const optimized = await getImage({
            src: image,
            format: "webp",
            quality: 80,
        });
        bgUrl = optimized.src;
    } catch (e) {
        console.error("HeroCard Image Error:", e);
        bgUrl = logo.src;
        isLogo = true;
    }
} else {
    bgUrl = logo.src;
    isLogo = true;
}

const isCompact = mode === "compact";
---

<Tag href={href} class="block w-full relative group cursor-pointer z-0">
    {
        /* ▼修正: 虹色の発光エフェクト (Shadow/Glow)
        !isCompact (つまり NEXT EVENT / NOW OPEN) の場合のみ表示する。
        UPCOMING (Compactモード) には表示しない。
    */
    }
    {
        !isCompact && (
            <div
                class:list={[
                    "absolute inset-0 bg-gradient-to-br from-accent-blue via-accent-yellow to-accent-red transition duration-500 rounded-3xl -z-10 blur-xl",
                    "opacity-30 group-hover:opacity-70",
                ]}
            ></div>
        )
    }

    {/* Surface */}
    <div
        class:list={[
            "relative w-full bg-zinc-900 overflow-hidden transition-all duration-300 rounded-2xl",
            // Compactモードの場合は枠線をしっかり出す。Normalモードは虹色があるので枠線は控えめに（または虹色に任せる）。
            isCompact
                ? "border border-zinc-800 group-hover:border-zinc-700"
                : "border border-zinc-800/50",
            isCompact ? "flex flex-row h-40" : "flex flex-col",
        ]}
    >
        {/* Image Area */}
        <div
            class:list={[
                "relative bg-zinc-950 overflow-hidden shrink-0 z-10 flex items-center justify-center",
                isCompact ? "w-1/3" : "h-64 w-full",
            ]}
        >
            <div
                class:list={[
                    "absolute inset-0 transition-transform duration-500 group-hover:scale-105",
                    isLogo ? "bg-no-repeat bg-center opacity-30" : "bg-cover",
                ]}
                style={`background-image: url('${bgUrl}'); ${isLogo ? "background-size: 50%; background-position: center;" : `background-position: ${imagePosition};`}`}
            >
            </div>

            {/* Overlay */}
            {
                !isLogo && (
                    <div class="absolute inset-0 bg-black/20 group-hover:bg-transparent transition-colors duration-500" />
                )
            }
            {
                !isCompact && !isLogo && (
                    <div class="absolute inset-0 bg-gradient-to-t from-zinc-900 via-zinc-900/20 to-transparent opacity-90" />
                )
            }
        </div>

        {/* Content Area */}
        <div
            class:list={[
                "relative flex-1 min-w-0 flex flex-col z-10",
                isCompact ? "p-4 justify-center" : "p-6 -mt-12 space-y-5",
            ]}
        >
            <div class={isCompact ? "space-y-1" : ""}>
                <h3
                    class:list={[
                        "flex flex-wrap items-baseline font-bold text-white tracking-tighter leading-none font-en",
                        isCompact
                            ? "flex-col gap-y-0.5 mb-1"
                            : "text-3xl gap-x-3 mb-3",
                    ]}
                >
                    <span class={isCompact ? "text-xl" : ""}>{title}</span>
                    <span
                        class:list={[
                            "font-bold tracking-normal",
                            isCompact
                                ? "text-xs text-zinc-500"
                                : "text-xl text-zinc-500",
                        ]}>{subTitle}</span
                    >
                </h3>

                {/* Meta */}
                {
                    !isCompact && (
                        <div class="flex items-center gap-4 text-xs font-bold text-zinc-500 font-en tracking-widest uppercase">
                            <span class="flex items-center gap-2 text-zinc-300">
                                <span class="w-1.5 h-1.5 rounded-full bg-accent-red" />
                                {date}
                            </span>
                            <span class="w-px h-2.5 bg-zinc-700" />
                            <span>{time}</span>
                            <span class="w-px h-2.5 bg-zinc-700" />
                            <span>@ {place}</span>
                        </div>
                    )
                }

                {/* Compact Meta */}
                {
                    isCompact && (
                        <div class="space-y-1">
                            <div class="flex items-center gap-2 text-[10px] font-bold text-zinc-400 font-en tracking-wider">
                                <span>{date}</span>
                                <span class="text-zinc-700">/</span>
                                <span>{time}</span>
                            </div>
                        </div>
                    )
                }
            </div>

            {/* Footer */}
            {
                !isCompact && (
                    <>
                        <div class="h-px w-full bg-zinc-800" />
                        <div class="flex items-center justify-between pt-1">
                            <div>
                                <p class="text-[10px] text-zinc-600 uppercase tracking-widest mb-0.5 font-en">
                                    Entrance
                                </p>
                                <p class="text-xl font-bold text-white font-en">
                                    {price}
                                </p>
                            </div>
                            <div class="w-10 h-10 rounded-xl bg-zinc-800 text-zinc-400 flex items-center justify-center group-hover:bg-white group-hover:text-black transition-colors duration-300">
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    width="20"
                                    height="20"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                >
                                    <>
                                        <path d="M5 12h14" />
                                        <path d="m12 5 7 7-7 7" />
                                    </>
                                </svg>
                            </div>
                        </div>
                    </>
                )
            }

            {/* Compact Footer */}
            {
                isCompact && (
                    <div class="flex items-end justify-between mt-auto pt-2 border-t border-zinc-800">
                        <div class="flex items-center gap-2">
                            <span class="text-[10px] text-zinc-500 font-en bg-zinc-800/50 px-1.5 py-0.5 rounded border border-zinc-800">
                                {place}
                            </span>
                        </div>
                        <div class="text-xs font-bold text-zinc-300 font-en">
                            {price}
                        </div>
                    </div>
                )
            }
        </div>
    </div>
</Tag>
