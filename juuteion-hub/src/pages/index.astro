---
import Layout from "../layouts/Layout.astro";
import Button from "../components/ui/Button.astro";
import HeroCard from "../components/ui/HeroCard.astro";
import ArchiveCard from "../components/ui/ArchiveCard.astro";
import Tag from "../components/ui/Tag.astro";
import SectionHeader from "../components/ui/SectionHeader.astro";
import logo from "../assets/logo/jto_logo.svg";

// ▼ Firebase関連のインポートに変更
import { db } from "../lib/firebase/client";
import { collection, getDocs, query, orderBy } from "firebase/firestore";

// 1. データ取得 (Firestore)
let allEvents: any[] = [];
try {
	// 日付の新しい順（降順）で取得
	const q = query(collection(db, "events"), orderBy("date", "desc"));
	const snapshot = await getDocs(q);

	allEvents = snapshot.docs.map((doc) => {
		const data = doc.data();
		return {
			id: doc.id,
			...data,
			// TimestampをDate型に変換
			date: data.date?.toDate ? data.date.toDate() : new Date(data.date),
		};
	});
} catch (e) {
	console.error("Firestore fetch error:", e);
	// エラー時は空配列（ビルドが落ちないように）
}

const latestData = allEvents[0]; // 最新1件
const archiveData = allEvents.slice(1); // それ以降

// ユーティリティ
const formatDate = (date: Date) => {
	if (!date) return "---";
	const y = date.getFullYear();
	const m = String(date.getMonth() + 1).padStart(2, "0");
	const d = String(date.getDate()).padStart(2, "0");
	const day = ["SUN", "MON", "TUE", "WED", "THU", "FRI", "SAT"][
		date.getDay()
	];
	return `${y}.${m}.${d} ${day}`;
};

// LATESTデータ (Hero Section用)
const nextEvent = latestData
	? {
			title: latestData.title,
			subTitle: latestData.subTitle ?? "",
			date: formatDate(latestData.date),
			rawDate: latestData.date,
			time: latestData.time,
			place: latestData.place,
			// HeroCardには「正方形のサムネイル」を渡す
			image: latestData.thumbnail,
			// 背景には「縦長のメインビジュアル」を使う
			bgImage: latestData.mainVisual,
			price: latestData.price,
			// 詳細ページへのリンク（IDベースに変更するなら /events/[id] だが、今回はslugが無いのでIDを使うか検討）
			// ※詳細ページ側も後でFirestore対応が必要ですが、一旦IDを渡します
			href: `/events/${latestData.id}`,
		}
	: null;

// ARCHIVEデータ
const pastEvents = archiveData.map((event) => ({
	title: event.title,
	subTitle: event.subTitle,
	date: formatDate(event.date),
	place: event.place,
	image: event.thumbnail,
	href: `/events/${event.id}`,
}));

// ステータス判定ロジック
const getEventStatus = (eventDate: Date, statusOverride?: string) => {
	// 管理画面で手動設定されたステータスがあれば優先
	if (statusOverride && statusOverride !== "upcoming") {
		// upcoming以外(soldout, open, archive)ならそれを色判定に使う
		if (statusOverride === "soldout")
			return { label: "SOLD OUT", color: "default" }; // 赤線などはCSSでやるが一旦default
		if (statusOverride === "open")
			return { label: "NOW OPEN", color: "red" };
		if (statusOverride === "archive")
			return { label: "ARCHIVE", color: "default" };
	}

	const today = new Date();
	today.setHours(0, 0, 0, 0);
	const target = new Date(eventDate);
	target.setHours(0, 0, 0, 0);

	if (target.getTime() === today.getTime()) {
		return { label: "NOW OPEN", color: "red" };
	} else if (target > today) {
		return { label: "COMING SOON", color: "yellow" };
	} else {
		return { label: "ARCHIVE", color: "default" };
	}
};

const status = nextEvent
	? getEventStatus(nextEvent.rawDate, latestData.status)
	: { label: "", color: "default" };

// 背景画像のURL (FirestoreのURLをそのまま使う)
const bgStyle = nextEvent?.bgImage
	? `background-image: url('${nextEvent.bgImage}')`
	: "";
---

<Layout title="TOP" isFluid={true}>
	{
		nextEvent ? (
			<>
				<div class="flex flex-col lg:flex-row min-h-screen">
					{/* [LEFT COLUMN] Visual Only */}
					<aside class="hidden lg:block flex-1 h-screen sticky top-0 left-0 overflow-hidden border-r border-subtle min-w-0">
						<div
							class="absolute inset-0 bg-cover bg-center transition-all duration-700 hover:scale-105"
							style={bgStyle}
						/>
						{/* Overlay for readability if needed */}
						<div class="absolute inset-0 bg-black/30" />
					</aside>

					{/* [RIGHT COLUMN] Content */}
					<main class="w-full lg:w-[700px] lg:shrink-0 bg-background relative z-10 border-l border-subtle">
						{/* Mobile Header */}
						<header class="lg:hidden flex justify-center items-center p-4 border-b border-subtle bg-background/80 backdrop-blur-md sticky top-0 z-50 h-16">
							<div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2">
								<img
									src={logo.src}
									alt="JUUTEION"
									class="h-8 w-auto opacity-100 mb-2"
								/>
							</div>
						</header>

						{/* 1. Hero Section */}
						<section
							id="top"
							class="relative w-full aspect-[4/5] lg:aspect-[16/10] overflow-hidden border-b border-subtle bg-surface"
						>
							{/* Mobile BG */}
							<div
								class="lg:hidden absolute inset-0 bg-cover bg-center"
								style={bgStyle}
							/>
							<div class="lg:hidden absolute inset-0 bg-gradient-to-t from-background via-background/20 to-transparent" />

							<div class="absolute inset-0 p-8 md:p-12 lg:p-16 flex flex-col justify-end items-start">
								<div class="w-full relative z-10">
									{/* Title */}
									<h2 class="flex flex-wrap items-baseline gap-x-4 text-5xl lg:text-6xl font-bold text-white tracking-tighter leading-none mb-6 drop-shadow-2xl lg:drop-shadow-none font-en">
										<span>{nextEvent.title}</span>
										<span class="text-3xl lg:text-4xl text-zinc-500 font-normal tracking-normal">
											{nextEvent.subTitle}
										</span>
									</h2>

									{/* Meta Info */}
									<div class="flex flex-wrap items-center gap-x-5 gap-y-2 mb-8 text-sm font-bold text-white tracking-widest font-en">
										<div class="flex items-center gap-3">
											<Tag
												variant={status.color as any}
												class="font-en"
											>
												{status.label}
											</Tag>
											<span>{nextEvent.date}</span>
										</div>
										<div class="flex items-center gap-3 opacity-90">
											<span class="hidden sm:block w-px h-3 bg-white/50" />
											<span>{nextEvent.time}</span>
											<span class="w-px h-3 bg-white/50" />
											<span>
												<span class="relative -top-[1px] inline-block">
													@
												</span>
												{nextEvent.place}
											</span>
										</div>
									</div>

									<div class="w-full sm:w-auto min-w-[200px]">
										<Button
											variant="primary"
											href={nextEvent.href}
										>
											詳細をチェック
										</Button>
									</div>
								</div>
							</div>
						</section>

						{/* Inner Content */}
						<div class="w-full px-8 md:px-12 py-24 space-y-32">
							{/* 2. About */}
							<section id="about" class="space-y-10">
								<SectionHeader
									title="About Us"
									accentColor="blue"
								/>

								<div class="space-y-6">
									<h3 class="text-3xl font-bold leading-tight font-sans pl-2">
										酔いどれケモナークラブイベント
										<br />
										獸酊音
									</h3>
								</div>
								<div class="space-y-6 text-base text-text-muted leading-relaxed text-justify font-sans pl-2">
									<p>
										クラブイベント初心者も楽しめる、ケモノ好きのためのコミュニティ空間。
										<br />
										ケモナーイベント開催時期に合わせて不定期オープン！
										<br />
										限定グッズの販売もあるかも！
									</p>
								</div>
							</section>

							{/* 3. Events */}
							<section id="events" class="space-y-12">
								<SectionHeader
									title="Information"
									accentColor="yellow"
									link={{
										href: "/events", // 一覧ページ（未作成なら不要かも）
										label: "VIEW ALL →",
									}}
								/>

								<div class="space-y-16">
									{/* Latest */}
									<div class="space-y-4">
										<p class="text-sm text-accent-yellow font-bold tracking-widest font-en pl-1">
											● NEXT EVENT
										</p>
										<HeroCard
											title={nextEvent.title}
											subTitle={nextEvent.subTitle}
											date={nextEvent.date}
											time={nextEvent.time}
											place={nextEvent.place}
											price={nextEvent.price}
											image={nextEvent.image}
											href={nextEvent.href}
										/>
									</div>

									{/* Archive */}
									{pastEvents.length > 0 && (
										<div class="space-y-4">
											<p class="text-sm text-text-muted font-bold tracking-widest font-en pl-1">
												● ARCHIVE
											</p>
											<div class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-6">
												{pastEvents.map((event) => (
													<ArchiveCard
														title={event.title}
														subTitle={
															event.subTitle
														}
														date={event.date}
														place={event.place}
														image={event.image}
														href={event.href}
													/>
												))}
											</div>
										</div>
									)}
								</div>
							</section>

							{/* 4. Social & VRC */}
							<section id="social" class="space-y-10">
								<SectionHeader
									title="Join the Floor"
									accentColor="red"
								/>
								<div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
									<a
										href="#"
										class="group bg-surface border border-subtle hover:border-accent-blue/50 rounded-2xl p-6 flex items-center justify-between transition-colors duration-300"
									>
										<div class="flex items-center gap-4">
											<div class="w-12 h-12 rounded-full bg-background flex items-center justify-center text-text-muted group-hover:text-white transition-colors border border-subtle group-hover:border-accent-blue/30">
												<svg
													xmlns="http://www.w3.org/2000/svg"
													width="20"
													height="20"
													viewBox="0 0 24 24"
													fill="currentColor"
												>
													<path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z" />
												</svg>
											</div>
											<div>
												<p class="text-base font-bold text-text-main font-en tracking-wide">
													Official X
												</p>
												<p class="text-xs text-text-muted mt-0.5 font-en">
													Latest Information
												</p>
											</div>
										</div>
										<span class="text-xs text-subtle group-hover:text-accent-blue transition-colors font-en">
											VIEW →
										</span>
									</a>
									<a
										href="#"
										class="group bg-surface border border-subtle hover:border-accent-red/50 rounded-2xl p-6 flex items-center justify-between transition-colors duration-300"
									>
										<div class="flex items-center gap-4">
											<div class="w-12 h-12 rounded-full bg-background flex items-center justify-center text-text-muted group-hover:text-white transition-colors border border-subtle group-hover:border-accent-red/30">
												<svg
													xmlns="http://www.w3.org/2000/svg"
													width="20"
													height="20"
													viewBox="0 0 24 24"
													fill="none"
													stroke="currentColor"
													stroke-width="2"
													stroke-linecap="round"
													stroke-linejoin="round"
												>
													<rect
														width="20"
														height="20"
														x="2"
														y="2"
														rx="5"
														ry="5"
													/>
													<path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z" />
													<line
														x1="17.5"
														x2="17.51"
														y1="6.5"
														y2="6.5"
													/>
												</svg>
											</div>
											<div>
												<p class="text-base font-bold text-text-main font-en tracking-wide">
													Instagram
												</p>
												<p class="text-xs text-text-muted mt-0.5 font-en">
													Photo Archive
												</p>
											</div>
										</div>
										<span class="text-xs text-subtle group-hover:text-accent-red transition-colors font-en">
											VIEW →
										</span>
									</a>
									<a
										href="#"
										class="sm:col-span-2 group bg-surface border border-subtle hover:border-accent-yellow/50 rounded-2xl p-6 flex items-center justify-between transition-colors duration-300"
									>
										<div class="flex items-center gap-4">
											<div class="w-12 h-12 rounded-full bg-background flex items-center justify-center text-text-muted group-hover:text-white transition-colors border border-subtle group-hover:border-accent-yellow/30">
												<span class="font-bold text-xs font-en">
													VRC
												</span>
											</div>
											<div>
												<p class="text-base font-bold text-text-main font-en tracking-wide">
													VRChat Group
												</p>
												<p class="text-xs text-text-muted mt-0.5 font-en">
													Join the virtual venue
												</p>
											</div>
										</div>
										<span class="text-xs text-subtle group-hover:text-accent-yellow transition-colors font-en">
											JOIN →
										</span>
									</a>
								</div>
							</section>

							<footer class="text-center pt-10 pb-20 border-t border-subtle">
								<p class="text-[10px] text-text-muted/30 font-mono font-en">
									© 2024 JUUTEION. All Rights Reserved.
								</p>
							</footer>
						</div>
					</main>
				</div>
			</>
		) : (
			<div class="min-h-screen flex flex-col items-center justify-center bg-zinc-950 text-white p-4 text-center">
				<img
					src={logo.src}
					alt="JUUTEION"
					class="w-24 opacity-50 mb-4"
				/>
				<p class="font-en tracking-widest text-sm text-zinc-500">
					NO EVENTS SCHEDULED
				</p>
			</div>
		)
	}
</Layout>
