---
import AdminLayout from "../../layouts/AdminLayout.astro";
import Input from "../../components/ui/Input.astro";

// --- スタイル定義 (長いクラス名をここに退避) ---
const SELECT_CLASS =
    "w-full bg-surface border border-subtle rounded-2xl px-5 py-4 text-base text-text-main focus:outline-none focus:border-accent-blue";

// ドロップゾーンの共通スタイル
const DROPZONE_BASE =
    "relative w-full bg-surface border-2 border-dashed border-subtle rounded-2xl overflow-hidden transition-colors group cursor-pointer";
// メイン画像用 (縦長 + 青ホバー)
const DROPZONE_MAIN = `${DROPZONE_BASE} aspect-[3/4] hover:border-accent-blue`;
// サムネイル用 (正方形 + 黄ホバー)
const DROPZONE_THUMB = `${DROPZONE_BASE} aspect-square hover:border-accent-yellow`;

// プレビュー表示エリアのスタイル
const PREVIEW_PLACEHOLDER =
    "absolute inset-0 flex flex-col items-center justify-center text-zinc-500 group-hover:text-white";
const PREVIEW_IMG = "absolute inset-0 w-full h-full object-cover hidden";
// ------------------------------------------
---

<AdminLayout title="New Event">
    <div class="max-w-4xl mx-auto space-y-8 pb-20">
        <div
            class="flex items-center justify-between border-b border-zinc-800 pb-4"
        >
            <h2 class="text-3xl font-bold font-en tracking-tight">New Event</h2>
            <a
                href="/admin"
                class="text-sm text-zinc-500 hover:text-white transition-colors"
            >
                キャンセルして戻る
            </a>
        </div>

        <form id="event-form" class="space-y-10">
            {/* 1. Basic Info */}
            <section class="space-y-6">
                <h3
                    class="text-xl font-bold text-white flex items-center gap-2"
                >
                    <span class="w-1 h-6 bg-accent-blue rounded-sm"></span>
                    基本情報
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <Input
                            label="Event Title"
                            name="title"
                            placeholder="イベント名 (例: 獸酊音)"
                            required
                        />
                        <Input
                            label="Sub Title"
                            name="subTitle"
                            placeholder="サブタイトル (例: Vol.1)"
                        />
                    </div>
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="space-y-2">
                                <Input
                                    label="Date"
                                    type="date"
                                    name="date"
                                    required
                                />
                            </div>
                            <div class="space-y-2">
                                <label
                                    class="text-xs text-text-muted uppercase tracking-widest block"
                                    >Status</label
                                >
                                <select name="status" class={SELECT_CLASS}>
                                    <option value="upcoming">UPCOMING</option>
                                    <option value="open">NOW OPEN</option>
                                    <option value="soldout">SOLD OUT</option>
                                    <option value="archive">ARCHIVE</option>
                                </select>
                            </div>
                        </div>
                        <Input
                            label="Open Time"
                            name="time"
                            placeholder="例: OPEN 23:00"
                            required
                        />
                    </div>
                </div>
            </section>

            {/* 2. Venue & Price */}
            <section class="space-y-6">
                <h3
                    class="text-xl font-bold text-white flex items-center gap-2"
                >
                    <span class="w-1 h-6 bg-accent-yellow rounded-sm"></span>
                    場所・料金
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <Input
                            label="Place Name"
                            name="place"
                            placeholder="会場名 (例: CLUB ASIA)"
                            required
                        />
                        <Input
                            label="Address"
                            name="address"
                            placeholder="住所 (GoogleMap用)"
                        />
                        <Input
                            label="Google Map Embed URL"
                            name="mapEmbed"
                            placeholder="Google Mapの埋め込みURL (src属性の中身)"
                        />
                    </div>
                    <div class="space-y-4">
                        <Input
                            label="Price Info"
                            name="price"
                            placeholder="例: ¥3,500 / 1D"
                            required
                        />
                    </div>
                </div>
            </section>

            {/* 3. Images (Client-side Compression) */}
            <section class="space-y-6">
                <h3
                    class="text-xl font-bold text-white flex items-center gap-2"
                >
                    <span class="w-1 h-6 bg-accent-red rounded-sm"></span>
                    画像設定
                </h3>
                <p class="text-xs text-zinc-500">
                    ※
                    選択した画像はブラウザ上で自動的に圧縮(WebP)・リサイズされます。<br
                    />
                    ※ 推奨: メイン(A版縦長)、サムネイル(正方形)
                </p>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    {/* Main Visual */}
                    <div class="space-y-2">
                        <label
                            class="text-xs text-text-muted uppercase tracking-widest block"
                            >Main Visual (詳細用)</label
                        >
                        {/* 修正: 定数化したクラスを使用 */}
                        <div class={DROPZONE_MAIN} id="drop-main">
                            <input
                                type="file"
                                id="input-main"
                                accept="image/*"
                                class="hidden"
                            />
                            <div
                                class={PREVIEW_PLACEHOLDER}
                                id="preview-main-placeholder"
                            >
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    width="32"
                                    height="32"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    class="mb-2"
                                    ><rect
                                        width="18"
                                        height="18"
                                        x="3"
                                        y="3"
                                        rx="2"
                                        ry="2"></rect><circle
                                        cx="9"
                                        cy="9"
                                        r="2"></circle><path
                                        d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"
                                    ></path></svg
                                >
                                <span class="text-xs font-bold"
                                    >CLICK TO UPLOAD</span
                                >
                            </div>
                            <img id="preview-main-img" class={PREVIEW_IMG} />
                        </div>
                    </div>

                    {/* Thumbnail */}
                    <div class="space-y-2">
                        <label
                            class="text-xs text-text-muted uppercase tracking-widest block"
                            >Thumbnail (一覧用)</label
                        >
                        {/* 修正: 定数化したクラスを使用 */}
                        <div class={DROPZONE_THUMB} id="drop-thumb">
                            <input
                                type="file"
                                id="input-thumb"
                                accept="image/*"
                                class="hidden"
                            />
                            <div
                                class={PREVIEW_PLACEHOLDER}
                                id="preview-thumb-placeholder"
                            >
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    width="32"
                                    height="32"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    class="mb-2"
                                    ><rect
                                        width="18"
                                        height="18"
                                        x="3"
                                        y="3"
                                        rx="2"
                                        ry="2"></rect><circle
                                        cx="9"
                                        cy="9"
                                        r="2"></circle><path
                                        d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"
                                    ></path></svg
                                >
                                <span class="text-xs font-bold"
                                    >CLICK TO UPLOAD</span
                                >
                            </div>
                            <img id="preview-thumb-img" class={PREVIEW_IMG} />
                        </div>
                    </div>
                </div>
            </section>

            {/* 4. Markdown Body */}
            <section class="space-y-6">
                <h3
                    class="text-xl font-bold text-white flex items-center gap-2"
                >
                    <span class="w-1 h-6 bg-subtle rounded-sm"></span>
                    詳細本文 (Markdown)
                </h3>
                <Input
                    name="body"
                    multiline
                    rows="15"
                    placeholder="# タイムテーブル
- 23:00 OPEN

## 注意事項
..."
                    class="font-mono text-sm leading-relaxed"
                />
            </section>

            {/* Action Bar */}
            <div class="sticky bottom-6 z-50">
                <button
                    type="submit"
                    id="submit-btn"
                    class="w-full bg-white text-black font-bold text-lg py-4 rounded-2xl shadow-xl hover:bg-zinc-200 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                >
                    <span>PUBLISH EVENT</span>
                </button>
            </div>
        </form>
    </div>

    <script>
        import { db, storage } from "../../lib/firebase/client";
        import {
            collection,
            addDoc,
            serverTimestamp,
        } from "firebase/firestore";
        import { ref, uploadBytes, getDownloadURL } from "firebase/storage";

        // === Image Compression Logic ===
        const COMPRESS_QUALITY = 0.8;
        const MAX_WIDTH = 1200;

        const processImage = async (file: File): Promise<Blob> => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target?.result as string;
                    img.onload = () => {
                        const canvas = document.createElement("canvas");
                        let width = img.width;
                        let height = img.height;

                        if (width > MAX_WIDTH) {
                            height *= MAX_WIDTH / width;
                            width = MAX_WIDTH;
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext("2d");
                        ctx?.drawImage(img, 0, 0, width, height);

                        canvas.toBlob(
                            (blob) => {
                                if (blob) resolve(blob);
                                else reject(new Error("Compression failed"));
                            },
                            "image/webp",
                            COMPRESS_QUALITY,
                        );
                    };
                };
                reader.onerror = (error) => reject(error);
            });
        };

        // === UI Helpers ===
        const setupImageUploader = (
            inputId: string,
            dropZoneId: string,
            imgId: string,
            placeholderId: string,
        ) => {
            const input = document.getElementById(inputId) as HTMLInputElement;
            const dropZone = document.getElementById(dropZoneId);
            const img = document.getElementById(imgId) as HTMLImageElement;
            const placeholder = document.getElementById(placeholderId);

            let selectedFile: File | null = null;

            const handleFile = (file: File) => {
                selectedFile = file;
                const reader = new FileReader();
                reader.onload = (e) => {
                    img.src = e.target?.result as string;
                    img.classList.remove("hidden");
                    placeholder?.classList.add("hidden");
                };
                reader.readAsDataURL(file);
            };

            dropZone?.addEventListener("click", () => input.click());
            input.addEventListener("change", (e: any) => {
                if (e.target.files?.[0]) handleFile(e.target.files[0]);
            });

            return () => selectedFile;
        };

        const getMainFile = setupImageUploader(
            "input-main",
            "drop-main",
            "preview-main-img",
            "preview-main-placeholder",
        );
        const getThumbFile = setupImageUploader(
            "input-thumb",
            "drop-thumb",
            "preview-thumb-img",
            "preview-thumb-placeholder",
        );

        // === Form Submission ===
        const form = document.getElementById("event-form") as HTMLFormElement;
        const submitBtn = document.getElementById(
            "submit-btn",
        ) as HTMLButtonElement;

        form?.addEventListener("submit", async (e) => {
            e.preventDefault();
            if (!confirm("この内容でイベントを保存しますか？")) return;

            const mainFile = getMainFile();
            const thumbFile = getThumbFile();

            if (!mainFile || !thumbFile) {
                alert("画像(Main/Thumbnail)は両方必須です");
                return;
            }

            try {
                submitBtn.disabled = true;
                submitBtn.innerText = "PROCESSING...";

                // 1. Process & Upload Images
                const uploadImage = async (file: File, pathPrefix: string) => {
                    const blob = await processImage(file);
                    const filename = `${Date.now()}_${pathPrefix}.webp`;
                    const storageRef = ref(storage, `events/${filename}`);
                    await uploadBytes(storageRef, blob);
                    return await getDownloadURL(storageRef);
                };

                submitBtn.innerText = "UPLOADING IMAGES...";
                const [mainUrl, thumbUrl] = await Promise.all([
                    uploadImage(mainFile, "main"),
                    uploadImage(thumbFile, "thumb"),
                ]);

                // 2. Save to Firestore
                submitBtn.innerText = "SAVING DATA...";
                const formData = new FormData(form);

                const eventData = {
                    title: formData.get("title"),
                    subTitle: formData.get("subTitle"),
                    date: new Date(formData.get("date") as string), // Date型に変換
                    time: formData.get("time"),
                    place: formData.get("place"),
                    address: formData.get("address"),
                    mapEmbed: formData.get("mapEmbed"),
                    price: formData.get("price"),
                    status: formData.get("status"),
                    body: formData.get("body"), // Markdown content
                    mainVisual: mainUrl,
                    thumbnail: thumbUrl,
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp(),
                };

                await addDoc(collection(db, "events"), eventData);

                alert("保存しました！ダッシュボードに戻ります。");
                window.location.href = "/admin";
            } catch (error) {
                console.error(error);
                alert("エラーが発生しました: " + error);
                submitBtn.disabled = false;
                submitBtn.innerText = "PUBLISH EVENT";
            }
        });
    </script>
</AdminLayout>
