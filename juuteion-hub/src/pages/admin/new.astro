<script>
    import { db, storage } from "../../lib/firebase/client";
    import { collection, addDoc, serverTimestamp } from "firebase/firestore";
    import { ref, uploadBytes, getDownloadURL } from "firebase/storage";

    // ▼ View Transitions対応: ページ読み込み/遷移ごとに実行する関数を作成
    const initPage = () => {
        const form = document.getElementById("event-form") as HTMLFormElement;
        if (!form) return; // このページじゃない場合は終了

        // === 1. UI Elements ===
        const timePrefix = document.getElementById(
            "time-prefix",
        ) as HTMLSelectElement;
        const timeValue = document.getElementById(
            "time-value",
        ) as HTMLInputElement;
        const timeHidden = document.getElementById(
            "time-hidden",
        ) as HTMLInputElement;
        const submitBtn = document.getElementById(
            "submit-btn",
        ) as HTMLButtonElement;

        const ttContainer = document.getElementById("tt-container");
        const priceContainer = document.getElementById("price-container");
        const tmplTt = document.getElementById(
            "tmpl-tt-row",
        ) as HTMLTemplateElement;
        const tmplPrice = document.getElementById(
            "tmpl-price-row",
        ) as HTMLTemplateElement;

        // === Helper Functions ===
        const addRow = (
            container: HTMLElement | null,
            template: HTMLTemplateElement | null,
        ) => {
            if (!container || !template) return;
            const clone = template.content.cloneNode(true) as DocumentFragment;

            clone
                .querySelector(".btn-remove")
                ?.addEventListener("click", (e) => {
                    (e.target as HTMLElement).closest(".flex")?.remove();
                });

            // LATE DISCOUNT Logic
            const typeSelect = clone.querySelector(
                ".input-type",
            ) as HTMLSelectElement;
            const lateTimeInput = clone.querySelector(
                ".input-late-time",
            ) as HTMLInputElement;
            if (typeSelect && lateTimeInput) {
                typeSelect.addEventListener("change", () => {
                    if (typeSelect.value === "LATE DISCOUNT") {
                        lateTimeInput.classList.remove("hidden");
                        lateTimeInput.required = true;
                    } else {
                        lateTimeInput.classList.add("hidden");
                        lateTimeInput.required = false;
                        lateTimeInput.value = "";
                    }
                });
            }
            container.appendChild(clone);
        };

        // === Event Listeners ===
        // 既存のリスナーが重複しないよう、cloneNodeでリセットするテクニックもありますが、
        // astro:page-loadならDOMが書き換わっているため新規登録でOK
        document
            .getElementById("add-tt-btn")
            ?.addEventListener("click", () => addRow(ttContainer, tmplTt));
        document
            .getElementById("add-price-btn")
            ?.addEventListener("click", () =>
                addRow(priceContainer, tmplPrice),
            );

        // 初期行の追加 (空の場合のみ)
        if (ttContainer && ttContainer.children.length === 0)
            addRow(ttContainer, tmplTt);
        if (priceContainer && priceContainer.children.length === 0)
            addRow(priceContainer, tmplPrice);

        // === Image Logic ===
        const processImage = async (file: File): Promise<Blob> => {
            // (省略なし: 画像処理ロジックはそのまま維持)
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target?.result as string;
                    img.onload = () => {
                        const canvas = document.createElement("canvas");
                        const MAX_WIDTH = 1200;
                        let w = img.width;
                        let h = img.height;
                        if (w > MAX_WIDTH) {
                            h *= MAX_WIDTH / w;
                            w = MAX_WIDTH;
                        }
                        canvas.width = w;
                        canvas.height = h;
                        canvas.getContext("2d")?.drawImage(img, 0, 0, w, h);
                        canvas.toBlob(
                            (b) => (b ? resolve(b) : reject()),
                            "image/webp",
                            0.8,
                        );
                    };
                };
            });
        };

        const setupImageUploader = (
            inputId: string,
            dropZoneId: string,
            imgId: string,
            placeholderId: string,
        ) => {
            const input = document.getElementById(inputId) as HTMLInputElement;
            const dropZone = document.getElementById(dropZoneId);
            const img = document.getElementById(imgId) as HTMLImageElement;
            const placeholder = document.getElementById(placeholderId);
            let selectedFile: File | null = null;

            if (!input || !dropZone) return () => null;

            const handleFile = (file: File) => {
                selectedFile = file;
                const reader = new FileReader();
                reader.onload = (e) => {
                    img.src = e.target?.result as string;
                    img.classList.remove("hidden");
                    placeholder?.classList.add("hidden");
                };
                reader.readAsDataURL(file);
            };

            dropZone.onclick = () => input.click(); // addEventListenerよりonclickが重複防止に安全
            dropZone.ondragover = (e) => {
                e.preventDefault();
                dropZone.classList.add("border-accent-blue");
            };
            dropZone.ondragleave = () =>
                dropZone.classList.remove("border-accent-blue");
            dropZone.ondrop = (e) => {
                e.preventDefault();
                dropZone.classList.remove("border-accent-blue");
                if (e.dataTransfer?.files?.[0])
                    handleFile(e.dataTransfer.files[0]);
            };
            input.onchange = (e: any) => {
                if (e.target.files?.[0]) handleFile(e.target.files[0]);
            };
            return () => selectedFile;
        };

        const getMainFile = setupImageUploader(
            "input-main",
            "drop-main",
            "preview-main-img",
            "preview-main-placeholder",
        );
        const getThumbFile = setupImageUploader(
            "input-thumb",
            "drop-thumb",
            "preview-thumb-img",
            "preview-thumb-placeholder",
        );

        // === Markdown Logic ===
        const generateMarkdown = () => {
            const intro = (
                document.getElementById("body-intro") as HTMLInputElement
            ).value;
            const notes = (
                document.getElementById("body-notes") as HTMLInputElement
            ).value;
            let md = "";
            if (intro) md += intro + "\n\n";

            // Timetable
            const ttRows = document.querySelectorAll(".row-tt");
            if (ttRows.length > 0) {
                let hasContent = false;
                let sectionMd = "## TIMETABLE\n";
                ttRows.forEach((row) => {
                    const time = (
                        row.querySelector(".input-time") as HTMLInputElement
                    ).value;
                    const content = (
                        row.querySelector(".input-content") as HTMLInputElement
                    ).value;
                    if (time && content) {
                        sectionMd += `- **${time}** ${content}\n`;
                        hasContent = true;
                    }
                });
                if (hasContent) md += sectionMd + "\n";
            }

            // Price
            const priceRows = document.querySelectorAll(".row-price");
            if (priceRows.length > 0) {
                let hasContent = false;
                let sectionMd =
                    "## ENTRANCE FEE\n| TICKET TYPE | PRICE |\n| :---------- | ----: |\n";
                priceRows.forEach((row) => {
                    const typeEl = row.querySelector(
                        ".input-type",
                    ) as HTMLSelectElement;
                    const priceEl = row.querySelector(
                        ".input-price",
                    ) as HTMLInputElement;
                    const lateTimeEl = row.querySelector(
                        ".input-late-time",
                    ) as HTMLInputElement;
                    if (priceEl.value) {
                        let label = typeEl.value;
                        if (label === "LATE DISCOUNT" && lateTimeEl.value)
                            label += ` (${lateTimeEl.value}~)`;
                        sectionMd += `| ${label} | ${priceEl.value} |\n`;
                        hasContent = true;
                    }
                });
                if (hasContent) md += sectionMd + "\n";
            }

            if (notes) md += "## ATTENTION\n" + notes;
            return md;
        };

        // === Submit Logic ===
        // 以前のリスナーを削除するために replaceWith を使うテクニック
        const newForm = form.cloneNode(true) as HTMLFormElement;
        form.parentNode?.replaceChild(newForm, form);

        newForm.addEventListener("submit", async (e) => {
            e.preventDefault(); // これが動くようになります！

            const mainFile = getMainFile();
            const thumbFile = getThumbFile();
            if (!mainFile || !thumbFile) {
                alert("画像(Main/Thumbnail)は両方必須です");
                return;
            }

            if (!confirm("この内容でイベントを保存しますか？")) return;

            // Time結合
            if (timeHidden && timePrefix && timeValue) {
                timeHidden.value = `${timePrefix.value} ${timeValue.value}`;
            }
            // Markdown生成
            (document.getElementById("final-body") as HTMLInputElement).value =
                generateMarkdown();

            // ボタン無効化
            const currentSubmitBtn = document.getElementById(
                "submit-btn",
            ) as HTMLButtonElement;
            if (currentSubmitBtn) {
                currentSubmitBtn.disabled = true;
                currentSubmitBtn.innerText = "PROCESSING...";
            }

            try {
                // Upload
                const uploadImage = async (file: File, prefix: string) => {
                    const blob = await processImage(file);
                    const filename = `${Date.now()}_${prefix}.webp`;
                    const storageRef = ref(storage, `events/${filename}`);
                    await uploadBytes(storageRef, blob);
                    return await getDownloadURL(storageRef);
                };

                if (currentSubmitBtn)
                    currentSubmitBtn.innerText = "UPLOADING...";
                const [mainUrl, thumbUrl] = await Promise.all([
                    uploadImage(mainFile, "main"),
                    uploadImage(thumbFile, "thumb"),
                ]);

                // Save
                if (currentSubmitBtn) currentSubmitBtn.innerText = "SAVING...";
                const formData = new FormData(newForm);

                const eventData = {
                    title: formData.get("title"),
                    subTitle: formData.get("subTitle"),
                    date: new Date(formData.get("date") as string),
                    time: formData.get("time"),
                    place: formData.get("place"),
                    address: formData.get("address"),
                    mapEmbed: formData.get("mapEmbed"),
                    price: formData.get("price"),
                    status: formData.get("status"),
                    body: formData.get("body"),
                    mainVisual: mainUrl,
                    thumbnail: thumbUrl,
                    ticketLink: formData.get("ticketLink"),
                    ticketDeadline: formData.get("ticketDeadline")
                        ? new Date(formData.get("ticketDeadline") as string)
                        : null,
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp(),
                };

                await addDoc(collection(db, "events"), eventData);
                alert("保存しました！");
                window.location.href = "/admin";
            } catch (error) {
                console.error(error);
                alert("エラー: " + error);
                if (currentSubmitBtn) {
                    currentSubmitBtn.disabled = false;
                    currentSubmitBtn.innerText = "PUBLISH EVENT";
                }
            }
        });
    };

    // ▼ View Transitionsイベントで実行
    document.addEventListener("astro:page-load", initPage);
</script>
