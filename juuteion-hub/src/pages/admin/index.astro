---
import AdminLayout from "../../layouts/AdminLayout.astro";
---

<AdminLayout title="Dashboard">
    <div class="space-y-8">
        <div class="flex items-center justify-between">
            <h2 class="text-2xl font-bold font-en tracking-tight text-white">
                Event List
            </h2>
            <a
                href="/admin/new"
                class="bg-white text-black px-4 py-2 rounded-lg text-sm font-bold hover:bg-zinc-200 transition-colors flex items-center gap-2"
            >
                <span class="text-lg leading-none mb-0.5">+</span> NEW EVENT
            </a>
        </div>

        {/* Loading Indicator */}
        <div
            id="loading-indicator"
            class="flex flex-col items-center justify-center py-20 space-y-4"
        >
            <div
                class="w-8 h-8 border-2 border-zinc-700 border-t-accent-blue rounded-full animate-spin"
            >
            </div>
            <p class="text-xs font-mono text-zinc-500 animate-pulse">
                LOADING DATA...
            </p>
        </div>

        {/* Empty State */}
        <div
            id="empty-state"
            class="hidden flex flex-col items-center justify-center py-20 border border-dashed border-zinc-800 rounded-2xl bg-zinc-900/30"
        >
            <p class="text-zinc-500 font-bold mb-2">NO EVENTS FOUND</p>
            <p class="text-xs text-zinc-600 mb-6">
                まだイベントが登録されていません
            </p>
            <a
                href="/admin/new"
                class="text-xs border border-zinc-700 text-zinc-400 px-4 py-2 rounded hover:text-white hover:border-zinc-500 transition-colors"
            >
                CREATE FIRST EVENT
            </a>
        </div>

        {/* List Container */}
        <div id="events-list" class="hidden space-y-3"></div>
    </div>

    <template id="event-item-template">
        <div
            class="group bg-surface border border-zinc-800 rounded-xl p-4 flex items-center gap-4 hover:border-zinc-700 transition-all"
        >
            {/* Thumb */}
            <div
                class="w-16 h-16 rounded-lg bg-zinc-900 shrink-0 overflow-hidden border border-zinc-800"
            >
                <img
                    src=""
                    alt=""
                    class="event-thumb w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity"
                />
            </div>

            {/* Info */}
            <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2 mb-1">
                    <span class="event-badge"></span>
                    <span class="event-id text-[10px] text-zinc-600 font-mono"
                    ></span>
                </div>
                <h3
                    class="event-title text-base font-bold text-white truncate font-en"
                >
                </h3>
                <div
                    class="flex items-center gap-3 text-xs text-zinc-500 mt-1 font-en"
                >
                    <span class="event-date flex items-center gap-1"></span>
                    <span class="w-px h-3 bg-zinc-800"></span>
                    <span class="event-place"></span>
                </div>
            </div>

            {/* Actions */}
            <div class="flex items-center gap-2">
                <a
                    href="#"
                    class="btn-edit p-2 text-zinc-500 hover:text-accent-blue hover:bg-accent-blue/10 rounded-lg transition-colors"
                    title="編集"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="18"
                        height="18"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        ><path
                            d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"
                        ></path></svg
                    >
                </a>
                <button
                    class="btn-delete p-2 text-zinc-500 hover:text-red-500 hover:bg-red-500/10 rounded-lg transition-colors"
                    title="削除"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="18"
                        height="18"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        ><path d="M3 6h18"></path><path
                            d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"
                        ></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"
                        ></path></svg
                    >
                </button>
            </div>
        </div>
    </template>
</AdminLayout>

<script>
    import { db, storage } from "../../lib/firebase/client";
    import {
        collection,
        getDocs,
        getDoc,
        query,
        orderBy,
        deleteDoc,
        doc,
    } from "firebase/firestore";
    import { ref, deleteObject } from "firebase/storage";

    // ▼ 日付フォーマット関数（JST対応版がない場合のための簡易版）
    const formatDate = (dateObj: any) => {
        if (!dateObj) return "---";
        const d = dateObj.toDate ? dateObj.toDate() : new Date(dateObj);
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const day = String(d.getDate()).padStart(2, "0");
        const week = ["SUN", "MON", "TUE", "WED", "THU", "FRI", "SAT"][
            d.getDay()
        ];
        return `${y}.${m}.${day} ${week}`;
    };

    const BADGE_STYLES: Record<string, string> = {
        upcoming:
            "bg-accent-yellow/10 text-accent-yellow border-accent-yellow/30",
        open: "bg-accent-red/10 text-accent-red border-accent-red/30",
        archive: "bg-zinc-800 text-zinc-500 border-zinc-700",
        soldout:
            "bg-zinc-800 text-zinc-400 border-zinc-700 line-through decoration-red-500",
    };

    // ▼ ページ読み込みごとに実行される関数
    const initPage = async () => {
        const loading = document.getElementById("loading-indicator");
        const list = document.getElementById("events-list");
        const empty = document.getElementById("empty-state");
        const template = document.getElementById(
            "event-item-template",
        ) as HTMLTemplateElement;

        // このページでない場合は終了
        if (!list || !template) return;

        // 画像削除ロジック
        const handleDelete = async (id: string, btn: HTMLButtonElement) => {
            try {
                btn.disabled = true;
                btn.innerHTML = "...";

                const docRef = doc(db, "events", id);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const deleteImageRef = async (url: string) => {
                        if (!url) return;
                        try {
                            const fileRef = ref(storage, url);
                            await deleteObject(fileRef);
                        } catch (e) {
                            console.warn("Image delete failed:", e);
                        }
                    };
                    await Promise.all([
                        deleteImageRef(data.mainVisual),
                        deleteImageRef(data.thumbnail),
                    ]);
                }

                await deleteDoc(docRef);
                const item = btn.closest("div.bg-surface");
                item?.remove();
                if (list.children.length === 0) {
                    list.classList.add("hidden");
                    empty?.classList.remove("hidden");
                }
                alert("削除しました。");
            } catch (e) {
                console.error(e);
                alert("削除に失敗しました: " + e);
                btn.disabled = false;
            }
        };

        // データ取得
        try {
            // ローディング表示、リスト・空状態非表示でリセット
            loading?.classList.remove("hidden");
            list.classList.add("hidden");
            empty?.classList.add("hidden");

            const q = query(collection(db, "events"), orderBy("date", "desc"));
            const querySnapshot = await getDocs(q);

            loading?.classList.add("hidden");

            if (querySnapshot.empty) {
                empty?.classList.remove("hidden");
                return;
            }

            list.classList.remove("hidden");
            list.innerHTML = ""; // リストをクリア

            querySnapshot.forEach((docSnap) => {
                const data = docSnap.data();
                const id = docSnap.id;
                const clone = template.content.cloneNode(
                    true,
                ) as DocumentFragment;

                const img = clone.querySelector(
                    ".event-thumb",
                ) as HTMLImageElement;
                img.src = data.thumbnail || "/favicon.svg";

                const badge = clone.querySelector(
                    ".event-badge",
                ) as HTMLElement;
                const status = (data.status || "archive") as string;
                badge.innerText = status;
                badge.className = `px-2 py-0.5 rounded text-[10px] font-bold tracking-widest uppercase border ${
                    BADGE_STYLES[status] || BADGE_STYLES.archive
                }`;

                (clone.querySelector(".event-title") as HTMLElement).innerText =
                    data.title;
                (clone.querySelector(".event-id") as HTMLElement).innerText =
                    `ID: ${id.slice(0, 6)}...`;
                (clone.querySelector(".event-date") as HTMLElement).innerText =
                    formatDate(data.date);
                (clone.querySelector(".event-place") as HTMLElement).innerText =
                    `@${data.place}`;
                const editBtn = clone.querySelector(
                    ".btn-edit",
                ) as HTMLAnchorElement;
                editBtn.href = `/admin/edit?id=${id}`;

                const deleteBtn = clone.querySelector(
                    ".btn-delete",
                ) as HTMLButtonElement;
                deleteBtn.onclick = async () => {
                    if (
                        confirm(
                            `イベント「${data.title}」を削除しますか？\n※関連する画像ファイルも削除されます。この操作は取り消せません。`,
                        )
                    ) {
                        await handleDelete(id, deleteBtn);
                    }
                };
                list.appendChild(clone);
            });
        } catch (error) {
            console.error("Fetch error:", error);
            alert("データの読み込みに失敗しました。");
            loading?.classList.add("hidden");
        }
    };

    // ▼ これが重要: ページ遷移ごとに実行
    document.addEventListener("astro:page-load", initPage);
</script>
