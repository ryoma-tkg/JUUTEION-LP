<script>
    import { db, storage } from "../../lib/firebase/client"; // storageを追加インポート
    import {
        collection,
        getDocs,
        getDoc, // 追加
        query,
        orderBy,
        deleteDoc,
        doc,
    } from "firebase/firestore";
    import { ref, deleteObject } from "firebase/storage"; // 追加

    // ... (定数定義などはそのまま) ...
    const loading = document.getElementById("loading-indicator");
    const list = document.getElementById("events-list");
    const empty = document.getElementById("empty-state");
    const template = document.getElementById(
        "event-item-template",
    ) as HTMLTemplateElement;

    const BADGE_STYLES: Record<string, string> = {
        upcoming:
            "bg-accent-yellow/10 text-accent-yellow border-accent-yellow/30",
        open: "bg-accent-red/10 text-accent-red border-accent-red/30",
        archive: "bg-zinc-800 text-zinc-500 border-zinc-700",
        soldout:
            "bg-zinc-800 text-zinc-400 border-zinc-700 line-through decoration-red-500",
    };

    const formatDate = (dateObj: any) => {
        if (!dateObj) return "---";
        const d = dateObj.toDate ? dateObj.toDate() : new Date(dateObj);
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const day = String(d.getDate()).padStart(2, "0");
        const week = ["SUN", "MON", "TUE", "WED", "THU", "FRI", "SAT"][
            d.getDay()
        ];
        return `${y}.${m}.${day} ${week}`;
    };

    const fetchEvents = async () => {
        // ... (fetchEventsの中身は以前と同じなので省略可、変更なし) ...
        try {
            const q = query(collection(db, "events"), orderBy("date", "desc"));
            const querySnapshot = await getDocs(q);

            loading?.classList.add("hidden");

            if (querySnapshot.empty) {
                empty?.classList.remove("hidden");
                return;
            }

            list?.classList.remove("hidden");
            list!.innerHTML = "";

            querySnapshot.forEach((docSnap) => {
                const data = docSnap.data();
                const id = docSnap.id;
                const clone = template.content.cloneNode(
                    true,
                ) as DocumentFragment;

                const img = clone.querySelector(
                    ".event-thumb",
                ) as HTMLImageElement;
                img.src = data.thumbnail || "/favicon.svg";

                const badge = clone.querySelector(
                    ".event-badge",
                ) as HTMLElement;
                const status = (data.status || "archive") as string;
                badge.innerText = status;
                badge.className = `px-2 py-0.5 rounded text-[10px] font-bold tracking-widest uppercase border ${BADGE_STYLES[status] || BADGE_STYLES.archive}`;

                (clone.querySelector(".event-title") as HTMLElement).innerText =
                    data.title;
                (clone.querySelector(".event-id") as HTMLElement).innerText =
                    `ID: ${id.slice(0, 6)}...`;
                (clone.querySelector(".event-date") as HTMLElement).innerText =
                    formatDate(data.date);
                (clone.querySelector(".event-place") as HTMLElement).innerText =
                    `@${data.place}`;

                const editBtn = clone.querySelector(
                    ".btn-edit",
                ) as HTMLAnchorElement;
                editBtn.href = `/admin/edit?id=${id}`;

                const deleteBtn = clone.querySelector(
                    ".btn-delete",
                ) as HTMLButtonElement;
                deleteBtn.onclick = async () => {
                    if (
                        confirm(
                            `イベント「${data.title}」を削除しますか？\n※関連する画像ファイルも削除されます。この操作は取り消せません。`,
                        )
                    ) {
                        await handleDelete(id, deleteBtn);
                    }
                };
                list?.appendChild(clone);
            });
        } catch (error) {
            console.error("Fetch error:", error);
            alert("データの読み込みに失敗しました。");
        }
    };

    // ▼▼▼ 修正ポイント: 画像削除ロジックを追加 ▼▼▼
    const handleDelete = async (id: string, btn: HTMLButtonElement) => {
        try {
            btn.disabled = true;
            btn.innerHTML = "...";

            // 1. まずドキュメントを取得して画像URLを特定する
            const docRef = doc(db, "events", id);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                const data = docSnap.data();

                // 画像削除ヘルパー
                const deleteImageRef = async (url: string) => {
                    if (!url) return;
                    try {
                        // Firebase StorageのURLから参照を作成して削除
                        const fileRef = ref(storage, url);
                        await deleteObject(fileRef);
                        console.log("Deleted image:", url);
                    } catch (e) {
                        console.warn(
                            "Image delete failed (might be already deleted):",
                            e,
                        );
                    }
                };

                // メイン画像とサムネイルを削除
                await Promise.all([
                    deleteImageRef(data.mainVisual),
                    deleteImageRef(data.thumbnail),
                ]);
            }

            // 2. ドキュメントを削除
            await deleteDoc(docRef);

            // 3. UI更新
            const item = btn.closest("div.bg-surface");
            item?.remove();

            if (list?.children.length === 0) {
                list.classList.add("hidden");
                empty?.classList.remove("hidden");
            }
            alert("削除しました。");
        } catch (e) {
            console.error(e);
            alert("削除に失敗しました: " + e);
            btn.disabled = false;
        }
    };
    // ▲▲▲ 修正エンド ▲▲▲

    fetchEvents();
</script>
