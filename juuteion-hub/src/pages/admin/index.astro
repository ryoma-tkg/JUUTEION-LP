<script>
    import { db, storage } from "../../lib/firebase/client";
    import {
        collection,
        getDocs,
        getDoc,
        query,
        orderBy,
        deleteDoc,
        doc,
    } from "firebase/firestore";
    import { ref, deleteObject } from "firebase/storage";
    import { formatDateJST } from "../../lib/utils/date";

    const BADGE_STYLES: Record<string, string> = {
        upcoming:
            "bg-accent-yellow/10 text-accent-yellow border-accent-yellow/30",
        open: "bg-accent-red/10 text-accent-red border-accent-red/30",
        archive: "bg-zinc-800 text-zinc-500 border-zinc-700",
        soldout:
            "bg-zinc-800 text-zinc-400 border-zinc-700 line-through decoration-red-500",
    };

    // ▼ 修正: ページロード後に実行する関数として定義
    const initPage = async () => {
        const loading = document.getElementById("loading-indicator");
        const list = document.getElementById("events-list");
        const empty = document.getElementById("empty-state");
        const template = document.getElementById(
            "event-item-template",
        ) as HTMLTemplateElement;

        // 要素がない場合（別のページなど）は終了
        if (!list || !template) return;

        // ▼▼▼ 修正ポイント: 画像削除ロジック ▼▼▼
        const handleDelete = async (id: string, btn: HTMLButtonElement) => {
            try {
                btn.disabled = true;
                btn.innerHTML = "...";

                // 1. まずドキュメントを取得して画像URLを特定する
                const docRef = doc(db, "events", id);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    // 画像削除ヘルパー
                    const deleteImageRef = async (url: string) => {
                        if (!url) return;
                        try {
                            const fileRef = ref(storage, url);
                            await deleteObject(fileRef);
                            console.log("Deleted image:", url);
                        } catch (e) {
                            console.warn("Image delete failed:", e);
                        }
                    };
                    await Promise.all([
                        deleteImageRef(data.mainVisual),
                        deleteImageRef(data.thumbnail),
                    ]);
                }

                // 2. ドキュメントを削除
                await deleteDoc(docRef);

                // 3. UI更新
                const item = btn.closest("div.bg-surface");
                item?.remove();
                if (list.children.length === 0) {
                    list.classList.add("hidden");
                    empty?.classList.remove("hidden");
                }
                alert("削除しました。");
            } catch (e) {
                console.error(e);
                alert("削除に失敗しました: " + e);
                btn.disabled = false;
            }
        };
        // ▲▲▲ 修正エンド ▲▲▲

        try {
            const q = query(collection(db, "events"), orderBy("date", "desc"));
            const querySnapshot = await getDocs(q);

            loading?.classList.add("hidden");

            if (querySnapshot.empty) {
                empty?.classList.remove("hidden");
                return;
            }

            list.classList.remove("hidden");
            list.innerHTML = "";

            querySnapshot.forEach((docSnap) => {
                const data = docSnap.data();
                const id = docSnap.id;
                const clone = template.content.cloneNode(
                    true,
                ) as DocumentFragment;

                const img = clone.querySelector(
                    ".event-thumb",
                ) as HTMLImageElement;
                if (img) img.src = data.thumbnail || "/favicon.svg";

                const badge = clone.querySelector(
                    ".event-badge",
                ) as HTMLElement;
                if (badge) {
                    const status = (data.status || "archive") as string;
                    badge.innerText = status;
                    badge.className = `px-2 py-0.5 rounded text-[10px] font-bold tracking-widest uppercase border ${BADGE_STYLES[status] || BADGE_STYLES.archive}`;
                }

                const titleEl = clone.querySelector(
                    ".event-title",
                ) as HTMLElement;
                if (titleEl) titleEl.innerText = data.title;

                const idEl = clone.querySelector(".event-id") as HTMLElement;
                if (idEl) idEl.innerText = `ID: ${id.slice(0, 6)}...`;

                const dateEl = clone.querySelector(
                    ".event-date",
                ) as HTMLElement;
                if (dateEl) {
                    dateEl.innerText = formatDateJST(
                        data.date?.toDate
                            ? data.date.toDate()
                            : new Date(data.date),
                    );
                }

                const placeEl = clone.querySelector(
                    ".event-place",
                ) as HTMLElement;
                if (placeEl) placeEl.innerText = `@${data.place}`;

                const editBtn = clone.querySelector(
                    ".btn-edit",
                ) as HTMLAnchorElement;
                if (editBtn) editBtn.href = `/admin/edit?id=${id}`;

                const deleteBtn = clone.querySelector(
                    ".btn-delete",
                ) as HTMLButtonElement;
                if (deleteBtn) {
                    deleteBtn.onclick = async () => {
                        if (
                            confirm(
                                `イベント「${data.title}」を削除しますか？\n※関連する画像ファイルも削除されます。この操作は取り消せません。`,
                            )
                        ) {
                            await handleDelete(id, deleteBtn);
                        }
                    };
                }
                list.appendChild(clone);
            });
        } catch (error) {
            console.error("Fetch error:", error);
            alert("データの読み込みに失敗しました。");
        }
    };

    // ▼ ページ読み込み時に実行
    document.addEventListener("astro:page-load", initPage);
</script>
