---
import AdminLayout from "../../layouts/AdminLayout.astro";
import Input from "../../components/ui/Input.astro";

// --- Style Definitions (省略: new.astroと同じ) ---
const STYLES = {
    sectionTitle: "text-xl font-bold text-white flex items-center gap-2",
    subTitle:
        "text-sm font-bold text-zinc-400 mt-6 mb-2 flex items-center gap-2",
    label: "text-xs text-text-muted uppercase tracking-widest block",
    select: "w-full bg-surface border border-subtle rounded-2xl px-5 py-4 text-base text-text-main focus:outline-none focus:border-accent-blue transition-colors cursor-pointer appearance-none",
    inputBase:
        "bg-surface border border-subtle rounded-xl px-4 py-3 text-sm text-text-main placeholder:text-text-muted/30 focus:outline-none focus:border-accent-blue transition-colors",
    dropzone: {
        base: "relative w-full bg-surface border-2 border-dashed border-subtle rounded-2xl overflow-hidden transition-colors group cursor-pointer",
        main: "aspect-[3/4] hover:border-accent-blue",
        thumb: "aspect-square hover:border-accent-yellow",
    },
    preview: {
        placeholder:
            "absolute inset-0 flex flex-col items-center justify-center text-zinc-500 group-hover:text-white transition-colors",
        img: "absolute inset-0 w-full h-full object-cover hidden",
        text: "text-xs font-bold",
    },
    submitBtn:
        "w-full bg-white text-black font-bold text-lg py-4 rounded-2xl shadow-xl hover:bg-zinc-200 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 cursor-pointer relative overflow-hidden",
    addBtn: "text-xs bg-zinc-800 hover:bg-zinc-700 text-white px-3 py-2 rounded-lg transition-colors flex items-center gap-1",
    removeBtn: "text-zinc-500 hover:text-red-500 transition-colors p-2",
    monoInput: "font-mono text-sm leading-relaxed",
};
---

<AdminLayout title="Edit Event">
    <div class="max-w-4xl mx-auto space-y-8 pb-20">
        <div
            class="flex items-center justify-between border-b border-zinc-800 pb-4"
        >
            <h2 class="text-3xl font-bold font-en tracking-tight">
                Edit Event
            </h2>
            <a
                href="/admin"
                class="text-sm text-zinc-500 hover:text-white transition-colors"
                >キャンセルして戻る</a
            >
        </div>

        <div
            id="loading-overlay"
            class="fixed inset-0 bg-zinc-950/80 z-50 flex items-center justify-center"
        >
            <div class="text-center">
                <div
                    class="w-10 h-10 border-4 border-zinc-800 border-t-accent-blue rounded-full animate-spin mb-4 mx-auto"
                >
                </div>
                <p class="text-sm font-mono text-zinc-400">
                    LOADING EVENT DATA...
                </p>
            </div>
        </div>

        <form id="event-form" class="space-y-10 hidden">
            <input type="hidden" name="id" id="event-id" />

            {/* 1. Basic Info */}
            <section class="space-y-6">
                <h3 class={STYLES.sectionTitle}>
                    <span class="w-1 h-6 bg-accent-blue rounded-sm"
                    ></span>基本情報
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <Input
                            label="Event Title"
                            name="title"
                            id="input-title"
                            required
                        />
                        <Input
                            label="Sub Title"
                            name="subTitle"
                            id="input-subTitle"
                        />
                    </div>
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="space-y-2">
                                <Input
                                    label="Date"
                                    type="date"
                                    name="date"
                                    id="input-date"
                                    required
                                />
                            </div>
                            <div class="space-y-2">
                                <label class={STYLES.label}>Status</label>
                                <select
                                    name="status"
                                    id="input-status"
                                    class={STYLES.select}
                                >
                                    <option value="upcoming">UPCOMING</option>
                                    <option value="open">NOW OPEN</option>
                                    <option value="soldout">SOLD OUT</option>
                                    <option value="archive">ARCHIVE</option>
                                </select>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <label class={STYLES.label}>Open Time</label>
                            <div class="flex gap-2">
                                <select
                                    id="time-prefix"
                                    class:list={[STYLES.select, "w-1/3"]}
                                >
                                    <option value="OPEN">OPEN</option>
                                    <option value="START">START</option>
                                </select>
                                <input
                                    type="time"
                                    id="time-value"
                                    class:list={[STYLES.select, "w-2/3"]}
                                    required
                                />
                            </div>
                            <input type="hidden" name="time" id="time-hidden" />
                        </div>
                    </div>
                </div>
            </section>

            {/* 2. Venue & Price */}
            <section class="space-y-6">
                <h3 class={STYLES.sectionTitle}>
                    <span class="w-1 h-6 bg-accent-yellow rounded-sm"
                    ></span>場所・料金
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <Input
                            label="Place Name"
                            name="place"
                            id="input-place"
                            required
                        />
                        <Input
                            label="Address"
                            name="address"
                            id="input-address"
                        />
                        <Input
                            label="Google Map Embed URL"
                            name="mapEmbed"
                            id="input-mapEmbed"
                        />
                    </div>
                    <div class="space-y-4">
                        <Input
                            label="Price Info (Short)"
                            name="price"
                            id="input-price"
                            required
                        />
                    </div>
                </div>
            </section>

            {/* 3. Ticket */}
            <section class="space-y-6">
                <h3 class={STYLES.sectionTitle}>
                    <span class="w-1 h-6 bg-accent-blue rounded-sm"
                    ></span>予約設定
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <Input
                            label="Ticket Link (TwiPla URL)"
                            name="ticketLink"
                            id="input-ticketLink"
                        />
                    </div>
                    <div class="space-y-4">
                        <div class="space-y-2">
                            <label class={STYLES.label}
                                >Reservation Deadline</label
                            >
                            <input
                                type="datetime-local"
                                name="ticketDeadline"
                                id="input-ticketDeadline"
                                class={STYLES.inputBase}
                            />
                        </div>
                    </div>
                </div>
            </section>

            {/* 4. Images */}
            <section class="space-y-6">
                <h3 class={STYLES.sectionTitle}>
                    <span class="w-1 h-6 bg-accent-red rounded-sm"
                    ></span>画像設定
                </h3>
                <p class="text-xs text-zinc-500">
                    ※
                    画像を変更しない場合は、そのままでOK（既存の画像が維持されます）。
                </p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="space-y-2">
                        <label class={STYLES.label}>Main Visual</label>
                        <div
                            class:list={[
                                STYLES.dropzone.base,
                                STYLES.dropzone.main,
                            ]}
                            id="drop-main"
                        >
                            <input
                                type="file"
                                id="input-main"
                                accept="image/*"
                                class="hidden"
                            />
                            <div
                                class={STYLES.preview.placeholder}
                                id="preview-main-placeholder"
                            >
                                <span class={STYLES.preview.text}
                                    >CLICK TO CHANGE</span
                                >
                            </div>
                            <img
                                id="preview-main-img"
                                class={STYLES.preview.img}
                            />
                        </div>
                        <input type="hidden" id="existing-main-url" />
                    </div>
                    <div class="space-y-2">
                        <label class={STYLES.label}>Thumbnail</label>
                        <div
                            class:list={[
                                STYLES.dropzone.base,
                                STYLES.dropzone.thumb,
                            ]}
                            id="drop-thumb"
                        >
                            <input
                                type="file"
                                id="input-thumb"
                                accept="image/*"
                                class="hidden"
                            />
                            <div
                                class={STYLES.preview.placeholder}
                                id="preview-thumb-placeholder"
                            >
                                <span class={STYLES.preview.text}
                                    >CLICK TO CHANGE</span
                                >
                            </div>
                            <img
                                id="preview-thumb-img"
                                class={STYLES.preview.img}
                            />
                        </div>
                        <input type="hidden" id="existing-thumb-url" />
                    </div>
                </div>
            </section>

            {/* 5. Details */}
            <section
                class="space-y-8 bg-zinc-900/50 p-6 rounded-3xl border border-zinc-800"
            >
                <h3 class={STYLES.sectionTitle}>
                    <span class="w-1 h-6 bg-subtle rounded-sm"
                    ></span>詳細コンテンツ
                </h3>
                <div>
                    <h4 class={STYLES.subTitle}>イントロダクション</h4>
                    <Input
                        id="body-intro"
                        multiline
                        rows="4"
                        class={STYLES.monoInput}
                    />
                </div>
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <h4 class={STYLES.subTitle}>TIMETABLE</h4>
                        <button
                            type="button"
                            id="add-tt-btn"
                            class={STYLES.addBtn}>＋ 追加</button
                        >
                    </div>
                    <div id="tt-container" class="space-y-2"></div>
                </div>
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <h4 class={STYLES.subTitle}>ENTRANCE FEE</h4>
                        <button
                            type="button"
                            id="add-price-btn"
                            class={STYLES.addBtn}>＋ 追加</button
                        >
                    </div>
                    <div id="price-container" class="space-y-2"></div>
                </div>
                <div>
                    <h4 class={STYLES.subTitle}>注意事項など</h4>
                    <Input
                        id="body-notes"
                        multiline
                        rows="4"
                        class={STYLES.monoInput}
                    />
                </div>
                <input type="hidden" name="body" id="final-body" />
            </section>

            <div class="sticky bottom-6 z-50">
                <button type="submit" id="submit-btn" class={STYLES.submitBtn}>
                    <span>UPDATE EVENT</span>
                </button>
            </div>
        </form>
    </div>

    {/* Templates */}
    <template id="tmpl-tt-row">
        <div class="flex gap-2 items-center group row-tt">
            <input
                type="time"
                class:list={[STYLES.inputBase, "w-32 input-time"]}
                required
            />
            <input
                type="text"
                class:list={[STYLES.inputBase, "flex-1 input-content"]}
                placeholder="Artist / Content"
                required
            />
            <button type="button" class={`${STYLES.removeBtn} btn-remove`}
                >×</button
            >
        </div>
    </template>

    <template id="tmpl-price-row">
        <div class="flex gap-2 items-center group row-price">
            <select class:list={[STYLES.inputBase, "w-40 input-type"]}>
                <option value="DOOR">DOOR</option>
                <option value="TwiPla">TwiPla</option>
                <option value="ADV">ADV</option>
                <option value="LATE DISCOUNT">LATE DISCOUNT</option>
                <option value="U-23">U-23</option>
                <option value="VRC">VRC割</option>
            </select>
            <input
                type="time"
                class:list={[STYLES.inputBase, "w-28 hidden input-late-time"]}
            />
            <input
                type="text"
                class:list={[STYLES.inputBase, "flex-1 input-price"]}
                placeholder="¥2,500"
                required
            />
            <button type="button" class={`${STYLES.removeBtn} btn-remove`}
                >×</button
            >
        </div>
    </template>

    <script>
        import { db, storage } from "../../lib/firebase/client";
        import {
            doc,
            getDoc,
            updateDoc,
            serverTimestamp,
        } from "firebase/firestore";
        import { ref, uploadBytes, getDownloadURL } from "firebase/storage";

        const initPage = () => {
            const form = document.getElementById(
                "event-form",
            ) as HTMLFormElement;
            if (!form) return;

            const params = new URLSearchParams(window.location.search);
            const eventId = params.get("id");
            if (!eventId) {
                alert("IDが指定されていません");
                window.location.href = "/admin";
                return;
            }

            const loadingOverlay = document.getElementById("loading-overlay");

            // UI Refs
            const refs = {
                title: document.getElementById(
                    "input-title",
                ) as HTMLInputElement,
                subTitle: document.getElementById(
                    "input-subTitle",
                ) as HTMLInputElement,
                date: document.getElementById("input-date") as HTMLInputElement,
                status: document.getElementById(
                    "input-status",
                ) as HTMLSelectElement,
                timePrefix: document.getElementById(
                    "time-prefix",
                ) as HTMLSelectElement,
                timeValue: document.getElementById(
                    "time-value",
                ) as HTMLInputElement,
                place: document.getElementById(
                    "input-place",
                ) as HTMLInputElement,
                address: document.getElementById(
                    "input-address",
                ) as HTMLInputElement,
                mapEmbed: document.getElementById(
                    "input-mapEmbed",
                ) as HTMLInputElement,
                price: document.getElementById(
                    "input-price",
                ) as HTMLInputElement,
                ticketLink: document.getElementById(
                    "input-ticketLink",
                ) as HTMLInputElement,
                ticketDeadline: document.getElementById(
                    "input-ticketDeadline",
                ) as HTMLInputElement,
                mainPreview: document.getElementById(
                    "preview-main-img",
                ) as HTMLImageElement,
                mainPlaceholder: document.getElementById(
                    "preview-main-placeholder",
                ) as HTMLElement,
                mainExisting: document.getElementById(
                    "existing-main-url",
                ) as HTMLInputElement,
                thumbPreview: document.getElementById(
                    "preview-thumb-img",
                ) as HTMLImageElement,
                thumbPlaceholder: document.getElementById(
                    "preview-thumb-placeholder",
                ) as HTMLElement,
                thumbExisting: document.getElementById(
                    "existing-thumb-url",
                ) as HTMLInputElement,
                intro: document.getElementById(
                    "body-intro",
                ) as HTMLInputElement,
                notes: document.getElementById(
                    "body-notes",
                ) as HTMLInputElement,
                ttContainer: document.getElementById("tt-container"),
                priceContainer: document.getElementById("price-container"),
            };

            const tmplTt = document.getElementById(
                "tmpl-tt-row",
            ) as HTMLTemplateElement;
            const tmplPrice = document.getElementById(
                "tmpl-price-row",
            ) as HTMLTemplateElement;

            const addRow = (
                container: HTMLElement | null,
                template: HTMLTemplateElement | null,
                data?: any,
            ) => {
                if (!container || !template) return;
                const clone = template.content.cloneNode(
                    true,
                ) as DocumentFragment;
                clone
                    .querySelector(".btn-remove")
                    ?.addEventListener("click", (e) => {
                        (e.target as HTMLElement).closest(".flex")?.remove();
                    });
                const typeSelect = clone.querySelector(
                    ".input-type",
                ) as HTMLSelectElement;
                const lateTimeInput = clone.querySelector(
                    ".input-late-time",
                ) as HTMLInputElement;
                if (typeSelect && lateTimeInput) {
                    const toggleTime = () => {
                        if (typeSelect.value === "LATE DISCOUNT") {
                            lateTimeInput.classList.remove("hidden");
                            lateTimeInput.required = true;
                        } else {
                            lateTimeInput.classList.add("hidden");
                            lateTimeInput.required = false;
                        }
                    };
                    typeSelect.addEventListener("change", toggleTime);
                    if (data && data.type.includes("LATE DISCOUNT")) {
                        typeSelect.value = "LATE DISCOUNT";
                        const match = data.type.match(/\((.*?)~\)/);
                        if (match) lateTimeInput.value = match[1];
                        toggleTime();
                    } else if (data && data.type) {
                        typeSelect.value = data.type;
                    }
                }
                if (data) {
                    if (data.time)
                        (
                            clone.querySelector(
                                ".input-time",
                            ) as HTMLInputElement
                        ).value = data.time;
                    if (data.content)
                        (
                            clone.querySelector(
                                ".input-content",
                            ) as HTMLInputElement
                        ).value = data.content;
                    if (data.price)
                        (
                            clone.querySelector(
                                ".input-price",
                            ) as HTMLInputElement
                        ).value = data.price;
                }
                container.appendChild(clone);
            };

            const parseMarkdown = (body: string) => {
                const lines = body.split("\n");
                let mode = "intro";
                lines.forEach((line) => {
                    line = line.trim();
                    if (!line) return;
                    if (line.startsWith("## TIMETABLE")) {
                        mode = "timetable";
                        return;
                    }
                    if (line.startsWith("## ENTRANCE FEE")) {
                        mode = "price";
                        return;
                    }
                    if (line.startsWith("## ATTENTION")) {
                        mode = "attention";
                        return;
                    }
                    if (mode === "intro") refs.intro.value += line + "\n";
                    else if (mode === "timetable") {
                        const match = line.match(/^-\s*\*\*(.*?)\*\*\s*(.*)$/);
                        if (match)
                            addRow(refs.ttContainer, tmplTt, {
                                time: match[1],
                                content: match[2],
                            });
                    } else if (mode === "price") {
                        if (
                            line.startsWith("|") &&
                            !line.includes("---") &&
                            !line.includes("TICKET TYPE")
                        ) {
                            const parts = line
                                .split("|")
                                .map((s) => s.trim())
                                .filter((s) => s);
                            if (parts.length >= 2)
                                addRow(refs.priceContainer, tmplPrice, {
                                    type: parts[0],
                                    price: parts[1],
                                });
                        }
                    } else if (mode === "attention")
                        refs.notes.value += line + "\n";
                });
            };

            const init = async () => {
                try {
                    const docRef = doc(db, "events", eventId);
                    const docSnap = await getDoc(docRef);
                    if (!docSnap.exists()) {
                        alert("イベントが見つかりませんでした");
                        window.location.href = "/admin";
                        return;
                    }
                    const data = docSnap.data();
                    refs.title.value = data.title;
                    refs.subTitle.value = data.subTitle || "";
                    const d = data.date.toDate();
                    refs.date.value = d.toISOString().split("T")[0];
                    refs.status.value = data.status || "archive";
                    refs.place.value = data.place;
                    refs.address.value = data.address || "";
                    refs.mapEmbed.value = data.mapEmbed || "";
                    refs.price.value = data.price;
                    if (data.time) {
                        const parts = data.time.split(" ");
                        if (parts.length >= 2) {
                            refs.timePrefix.value = parts[0];
                            refs.timeValue.value = parts[1];
                        } else {
                            refs.timeValue.value = data.time;
                        }
                    }
                    refs.ticketLink.value = data.ticketLink || "";
                    if (data.ticketDeadline) {
                        const td = data.ticketDeadline.toDate();
                        const pad = (n: number) => (n < 10 ? "0" + n : n);
                        refs.ticketDeadline.value = `${td.getFullYear()}-${pad(td.getMonth() + 1)}-${pad(td.getDate())}T${pad(td.getHours())}:${pad(td.getMinutes())}`;
                    }
                    if (data.mainVisual) {
                        refs.mainExisting.value = data.mainVisual;
                        refs.mainPreview.src = data.mainVisual;
                        refs.mainPreview.classList.remove("hidden");
                        refs.mainPlaceholder.classList.add("hidden");
                    }
                    if (data.thumbnail) {
                        refs.thumbExisting.value = data.thumbnail;
                        refs.thumbPreview.src = data.thumbnail;
                        refs.thumbPreview.classList.remove("hidden");
                        refs.thumbPlaceholder.classList.add("hidden");
                    }
                    if (data.body) parseMarkdown(data.body);
                    loadingOverlay?.classList.add("hidden");
                    form.classList.remove("hidden");
                } catch (e) {
                    console.error(e);
                    alert("読み込みエラー: " + e);
                }
            };

            const setupImageUploader = (
                inputId: string,
                dropZoneId: string,
                imgId: string,
                placeholderId: string,
            ) => {
                const input = document.getElementById(
                    inputId,
                ) as HTMLInputElement;
                const dropZone = document.getElementById(dropZoneId);
                const img = document.getElementById(imgId) as HTMLImageElement;
                const placeholder = document.getElementById(placeholderId);
                let selectedFile: File | null = null;
                if (!input || !dropZone) return () => null;
                const handleFile = (file: File) => {
                    selectedFile = file;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        img.src = e.target?.result as string;
                        img.classList.remove("hidden");
                        placeholder?.classList.add("hidden");
                    };
                    reader.readAsDataURL(file);
                };
                dropZone.onclick = () => input.click();
                dropZone.ondragover = (e) => {
                    e.preventDefault();
                    dropZone.classList.add("border-accent-blue");
                };
                dropZone.ondragleave = () =>
                    dropZone.classList.remove("border-accent-blue");
                dropZone.ondrop = (e) => {
                    e.preventDefault();
                    dropZone.classList.remove("border-accent-blue");
                    if (e.dataTransfer?.files?.[0])
                        handleFile(e.dataTransfer.files[0]);
                };
                input.onchange = (e: any) => {
                    if (e.target.files?.[0]) handleFile(e.target.files[0]);
                };
                return () => selectedFile;
            };

            const getMainFile = setupImageUploader(
                "input-main",
                "drop-main",
                "preview-main-img",
                "preview-main-placeholder",
            );
            const getThumbFile = setupImageUploader(
                "input-thumb",
                "drop-thumb",
                "preview-thumb-img",
                "preview-thumb-placeholder",
            );

            const generateMarkdown = () => {
                const intro = refs.intro.value;
                const notes = refs.notes.value;
                let md = "";
                if (intro) md += intro + "\n\n";
                const ttRows = document.querySelectorAll(".row-tt");
                if (ttRows.length > 0) {
                    let sectionMd = "## TIMETABLE\n";
                    ttRows.forEach((row) => {
                        const time = (
                            row.querySelector(".input-time") as HTMLInputElement
                        ).value;
                        const content = (
                            row.querySelector(
                                ".input-content",
                            ) as HTMLInputElement
                        ).value;
                        if (time && content)
                            sectionMd += `- **${time}** ${content}\n`;
                    });
                    md += sectionMd + "\n";
                }
                const priceRows = document.querySelectorAll(".row-price");
                if (priceRows.length > 0) {
                    let sectionMd =
                        "## ENTRANCE FEE\n| TICKET TYPE | PRICE |\n| :---------- | ----: |\n";
                    priceRows.forEach((row) => {
                        const typeEl = row.querySelector(
                            ".input-type",
                        ) as HTMLSelectElement;
                        const priceEl = row.querySelector(
                            ".input-price",
                        ) as HTMLInputElement;
                        const lateTimeEl = row.querySelector(
                            ".input-late-time",
                        ) as HTMLInputElement;
                        if (priceEl.value) {
                            let label = typeEl.value;
                            if (label === "LATE DISCOUNT" && lateTimeEl.value)
                                label += ` (${lateTimeEl.value}~)`;
                            sectionMd += `| ${label} | ${priceEl.value} |\n`;
                        }
                    });
                    md += sectionMd + "\n";
                }
                if (notes) md += "## ATTENTION\n" + notes;
                return md;
            };

            const processImage = async (file: File): Promise<Blob> => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = (e) => {
                        const img = new Image();
                        img.src = e.target?.result as string;
                        img.onload = () => {
                            const canvas = document.createElement("canvas");
                            const MAX_WIDTH = 1200;
                            let w = img.width,
                                h = img.height;
                            if (w > MAX_WIDTH) {
                                h *= MAX_WIDTH / w;
                                w = MAX_WIDTH;
                            }
                            canvas.width = w;
                            canvas.height = h;
                            canvas.getContext("2d")?.drawImage(img, 0, 0, w, h);
                            canvas.toBlob(
                                (b) => (b ? resolve(b) : reject()),
                                "image/webp",
                                0.8,
                            );
                        };
                    };
                });
            };

            document
                .getElementById("add-tt-btn")
                ?.addEventListener("click", () =>
                    addRow(refs.ttContainer, tmplTt),
                );
            document
                .getElementById("add-price-btn")
                ?.addEventListener("click", () =>
                    addRow(refs.priceContainer, tmplPrice),
                );

            form.addEventListener("submit", async (e) => {
                e.preventDefault();
                if (!confirm("変更を保存しますか？")) return;
                const submitBtn = document.getElementById(
                    "submit-btn",
                ) as HTMLButtonElement;
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.innerText = "UPDATING...";
                }
                try {
                    const mainFile = getMainFile();
                    const thumbFile = getThumbFile();
                    const uploadIfNeeded = async (
                        file: File | null,
                        prefix: string,
                        existingUrl: string,
                    ) => {
                        if (!file) return existingUrl;
                        const blob = await processImage(file);
                        const filename = `${Date.now()}_${prefix}_update.webp`;
                        const sRef = ref(storage, `events/${filename}`);
                        await uploadBytes(sRef, blob);
                        return await getDownloadURL(sRef);
                    };
                    const [mainUrl, thumbUrl] = await Promise.all([
                        uploadIfNeeded(
                            mainFile,
                            "main",
                            refs.mainExisting.value,
                        ),
                        uploadIfNeeded(
                            thumbFile,
                            "thumb",
                            refs.thumbExisting.value,
                        ),
                    ]);
                    const formData = new FormData(form);
                    const updateData = {
                        title: formData.get("title"),
                        subTitle: formData.get("subTitle"),
                        date: new Date(formData.get("date") as string),
                        time: `${refs.timePrefix.value} ${refs.timeValue.value}`,
                        place: formData.get("place"),
                        address: formData.get("address"),
                        mapEmbed: formData.get("mapEmbed"),
                        price: formData.get("price"),
                        status: formData.get("status"),
                        body: generateMarkdown(),
                        mainVisual: mainUrl,
                        thumbnail: thumbUrl,
                        ticketLink: formData.get("ticketLink"),
                        ticketDeadline: formData.get("ticketDeadline")
                            ? new Date(formData.get("ticketDeadline") as string)
                            : null,
                        updatedAt: serverTimestamp(),
                    };
                    if (eventId) {
                        await updateDoc(doc(db, "events", eventId), updateData);
                        alert("更新しました！");
                        window.location.href = "/admin";
                    }
                } catch (err) {
                    console.error(err);
                    alert("更新エラー: " + err);
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.innerText = "UPDATE EVENT";
                    }
                }
            });

            init();
        };

        document.addEventListener("astro:page-load", initPage);
    </script>
</AdminLayout>
