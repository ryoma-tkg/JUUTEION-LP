---
import Layout from "../../layouts/Layout.astro";
import Button from "../../components/ui/Button.astro";
import Tag from "../../components/ui/Tag.astro";
import SectionHeader from "../../components/ui/SectionHeader.astro";
import logo from "../../assets/logo/jto_logo.svg";

// ▼ Firestore & Markdown Parser
import { db } from "../../lib/firebase/client";
import { collection, getDocs } from "firebase/firestore";
import { marked } from "marked";

// ▼ 型定義 (TypeScriptエラー回避のため)
interface EventData {
    id: string;
    title: string;
    subTitle?: string;
    date: Date;
    time: string;
    place: string;
    price: string;
    mainVisual: string;
    status?: string;
    body?: string;
    mapEmbed?: string;
    address?: string;
    // ▼ 追加: 予約関連
    ticketLink?: string;
    ticketDeadline?: Date;
}

interface Props {
    event: EventData;
}

// 1. ビルド時に全イベントのパス（URL）を生成
export async function getStaticPaths() {
    const snapshot = await getDocs(collection(db, "events"));

    return snapshot.docs.map((doc) => {
        const data = doc.data();
        return {
            params: { id: doc.id },
            props: {
                event: {
                    id: doc.id,
                    title: data.title,
                    subTitle: data.subTitle,
                    time: data.time,
                    place: data.place,
                    price: data.price,
                    mainVisual: data.mainVisual,
                    status: data.status,
                    body: data.body,
                    mapEmbed: data.mapEmbed,
                    address: data.address,

                    // TimestampをDate型に変換
                    date: data.date?.toDate
                        ? data.date.toDate()
                        : new Date(data.date),

                    // ▼ 追加: 予約関連データのマッピング
                    ticketLink: data.ticketLink,
                    ticketDeadline: data.ticketDeadline?.toDate
                        ? data.ticketDeadline.toDate()
                        : data.ticketDeadline
                          ? new Date(data.ticketDeadline)
                          : null,
                } as EventData,
            },
        };
    });
}

// 2. ページ生成処理
const { event } = Astro.props;

// MarkdownをHTMLに変換
const contentHtml = await marked.parse(event.body || "");

// 日付フォーマット
const formatDate = (date: Date) => {
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, "0");
    const d = String(date.getDate()).padStart(2, "0");
    const day = ["SUN", "MON", "TUE", "WED", "THU", "FRI", "SAT"][
        date.getDay()
    ];
    return `${y}.${m}.${d} ${day}`;
};

// ステータス判定
const getEventStatus = (evt: EventData) => {
    if (evt.status === "soldout")
        return { label: "SOLD OUT", color: "default", isActive: false };
    if (evt.status === "open")
        return { label: "NOW OPEN", color: "red", isActive: true };
    if (evt.status === "archive")
        return { label: "ARCHIVE", color: "default", isActive: false };

    // UPCOMINGの場合の日付判定
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const target = new Date(evt.date);
    target.setHours(0, 0, 0, 0);

    if (target.getTime() === today.getTime()) {
        return { label: "NOW OPEN", color: "red", isActive: true };
    } else if (target > today) {
        return { label: "COMING SOON", color: "yellow", isActive: true };
    } else {
        return { label: "ARCHIVE", color: "default", isActive: false };
    }
};

const status = getEventStatus(event);

// ▼ 締切判定ロジック
const now = new Date();
const isDeadlinePassed = event.ticketDeadline
    ? now > event.ticketDeadline
    : false;
// 予約可能 = リンクがある AND 締切を過ぎていない
const canReserve = event.ticketLink && !isDeadlinePassed;
---

<Layout title={event.title} isFluid={true}>
    <div class="flex flex-col lg:flex-row min-h-screen">
        {/* [LEFT COLUMN] Visual Only (PC) */}
        <aside
            class="hidden lg:flex flex-1 h-screen sticky top-0 left-0 overflow-hidden border-r border-subtle min-w-0 bg-background items-center justify-center z-0"
        >
            <div class="absolute inset-0 opacity-20 pointer-events-none">
                <div
                    class="absolute top-1/4 left-1/4 w-96 h-96 bg-accent-blue/10 rounded-full blur-[100px]"
                >
                </div>
                <div
                    class="absolute bottom-1/4 right-1/4 w-96 h-96 bg-accent-red/10 rounded-full blur-[100px]"
                >
                </div>
            </div>
            {/* Logo Area */}
            <div class="relative z-10 text-center select-none opacity-80">
                <img
                    src={logo.src}
                    alt="JUUTEION"
                    class="mx-auto w-48 h-auto"
                    width="192"
                    height="192"
                />
            </div>
        </aside>

        {/* [RIGHT COLUMN] Content */}
        <main
            class="w-full lg:w-[700px] lg:shrink-0 bg-background relative z-10 border-l border-subtle"
        >
            {/* Mobile Header */}
            <header
                class="lg:hidden flex justify-between items-center p-4 px-6 border-b border-subtle bg-background/80 backdrop-blur-md sticky top-0 z-50 h-16"
            >
                <a
                    href="/"
                    class="flex items-center gap-2 text-text-muted hover:text-white transition-colors relative z-10"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="20"
                        height="20"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        ><path d="m15 18-6-6 6-6"></path></svg
                    >
                    <span class="font-bold text-sm font-en">BACK</span>
                </a>

                <div
                    class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2"
                >
                    <img
                        src={logo.src}
                        alt="JUUTEION"
                        class="h-6 w-auto opacity-90"
                    />
                </div>
            </header>

            {/* 1. Hero Section */}
            <div
                class="relative w-full bg-zinc-900 group border-b border-subtle overflow-hidden"
            >
                {/* Main Visual (URL string) */}
                <img
                    src={event.mainVisual}
                    alt={event.title}
                    class="w-full h-auto block"
                />

                <div
                    class="absolute bottom-0 left-0 right-0 h-2/3 bg-gradient-to-t from-background via-background/80 to-transparent"
                >
                </div>

                <div
                    class="absolute bottom-0 left-0 w-full p-8 md:p-12 flex flex-col justify-end z-20"
                >
                    <div class="space-y-4">
                        <h1
                            class="flex flex-col md:flex-row md:items-baseline flex-wrap gap-x-4 gap-y-1 font-bold tracking-tighter leading-none font-en"
                        >
                            <span
                                class="text-5xl lg:text-6xl text-white drop-shadow-2xl"
                            >
                                {event.title}
                            </span>
                            <span
                                class="text-2xl lg:text-3xl text-zinc-500 font-normal tracking-normal pb-1"
                            >
                                {event.subTitle}
                            </span>
                        </h1>

                        <div
                            class="flex flex-wrap items-center gap-x-6 gap-y-2 text-sm font-bold text-white tracking-widest font-en pt-2"
                        >
                            <div class="flex items-center gap-2">
                                <Tag
                                    variant={status.color as any}
                                    class="font-en"
                                >
                                    {status.label}
                                </Tag>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {/* Inner Content */}
            <div class="w-full px-8 md:px-12 py-12 lg:py-24 pb-32 space-y-24">
                <section>
                    <SectionHeader
                        title="Event Info"
                        accentColor="muted"
                        class="mb-6"
                    />
                    <div
                        class="bg-surface border border-subtle rounded-2xl p-6 space-y-4 shadow-lg"
                    >
                        {/* DATE */}
                        <div class="flex items-start gap-5">
                            <div
                                class="w-8 flex justify-center text-accent-blue mt-0.5"
                            >
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    width="20"
                                    height="20"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    ><rect
                                        width="18"
                                        height="18"
                                        x="3"
                                        y="4"
                                        rx="2"
                                        ry="2"></rect><line
                                        x1="16"
                                        x2="16"
                                        y1="2"
                                        y2="6"></line><line
                                        x1="8"
                                        x2="8"
                                        y1="2"
                                        y2="6"></line><line
                                        x1="3"
                                        x2="21"
                                        y1="10"
                                        y2="10"></line></svg
                                >
                            </div>
                            <div>
                                <p
                                    class="text-xs text-text-muted/50 font-bold tracking-widest font-en mb-1"
                                >
                                    DATE
                                </p>
                                <p class="text-lg font-bold text-white font-en">
                                    {formatDate(event.date)}
                                </p>
                                <p class="text-sm text-text-muted font-en">
                                    {event.time}
                                </p>
                            </div>
                        </div>
                        <div class="w-full h-px bg-subtle/50"></div>
                        {/* PLACE */}
                        <div class="flex items-start gap-5">
                            <div
                                class="w-8 flex justify-center text-accent-red mt-0.5"
                            >
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    width="20"
                                    height="20"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    ><path
                                        d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"
                                    ></path><circle cx="12" cy="10" r="3"
                                    ></circle></svg
                                >
                            </div>
                            <div>
                                <p
                                    class="text-xs text-text-muted/50 font-bold tracking-widest font-en mb-1"
                                >
                                    PLACE
                                </p>
                                <p class="text-lg font-bold text-white font-en">
                                    {event.place}
                                </p>
                            </div>
                        </div>
                        <div class="w-full h-px bg-subtle/50"></div>
                        {/* PRICE */}
                        <div class="flex items-start gap-5">
                            <div
                                class="w-8 flex justify-center text-accent-yellow mt-0.5"
                            >
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    width="20"
                                    height="20"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    ><rect
                                        width="20"
                                        height="12"
                                        x="2"
                                        y="6"
                                        rx="2"></rect><circle
                                        cx="12"
                                        cy="12"
                                        r="2"></circle><path d="M6 12h.01"
                                    ></path><path d="M18 12h.01"></path></svg
                                >
                            </div>
                            <div>
                                <p
                                    class="text-xs text-text-muted/50 font-bold tracking-widest font-en mb-1"
                                >
                                    PRICE
                                </p>
                                <p class="text-lg font-bold text-white font-en">
                                    {event.price}
                                </p>
                            </div>
                        </div>
                    </div>
                </section>

                {/* Markdown Body */}
                <div
                    class="prose prose-invert prose-sm md:prose-base max-w-none"
                >
                    <Fragment set:html={contentHtml} />
                </div>

                {
                    event.mapEmbed && (
                        <section id="access">
                            <SectionHeader
                                title="Access"
                                accentColor="muted"
                                class="mb-6"
                            />
                            <div class="space-y-4">
                                <div class="w-full aspect-video rounded-2xl overflow-hidden border border-subtle bg-surface shadow-lg relative group">
                                    <iframe
                                        src={event.mapEmbed}
                                        width="100%"
                                        height="100%"
                                        style="border:0; filter: grayscale(100%) invert(92%) hue-rotate(180deg) contrast(90%);"
                                        allowfullscreen=""
                                        loading="lazy"
                                        referrerpolicy="no-referrer-when-downgrade"
                                        class="w-full h-full opacity-70 group-hover:opacity-100 transition-opacity duration-500"
                                    />
                                    <div class="absolute inset-0 pointer-events-none border border-white/5 rounded-2xl" />
                                </div>
                                <div class="flex items-start justify-between gap-4 px-2">
                                    <div>
                                        <p class="text-lg font-bold text-white font-en">
                                            {event.place}
                                        </p>
                                        {event.address && (
                                            <p class="text-sm text-text-muted mt-1 font-sans">
                                                {event.address}
                                            </p>
                                        )}
                                    </div>
                                    <a
                                        href={`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(event.place + " " + (event.address || ""))}`}
                                        target="_blank"
                                        rel="noopener noreferrer"
                                        class="text-xs font-bold font-en text-accent-blue hover:text-white transition-colors border-b border-accent-blue/30 pb-0.5"
                                    >
                                        OPEN MAP →
                                    </a>
                                </div>
                            </div>
                        </section>
                    )
                }
            </div>

            {/* Footer Sticky Button */}
            {
                // status.isActive (イベント自体が終わっていない) かつ
                // ticketLinkが設定されている場合のみ表示
                status.isActive && event.ticketLink && (
                    <div class="sticky bottom-0 left-0 right-0 z-50 p-6 pb-8 bg-gradient-to-t from-background via-background to-transparent pointer-events-none">
                        <div class="w-full pointer-events-auto">
                            {canReserve ? (
                                <Button
                                    variant="primary"
                                    href={event.ticketLink}
                                    class="shadow-2xl shadow-accent-blue/20 w-full"
                                >
                                    TwiPlaで参加表明する
                                    {/* 締切日時があれば表示 */}
                                    {event.ticketDeadline && (
                                        <span class="text-[10px] ml-2 opacity-70 font-normal">
                                            (〆{" "}
                                            {event.ticketDeadline.getMonth() +
                                                1}
                                            /{event.ticketDeadline.getDate()}{" "}
                                            {String(
                                                event.ticketDeadline.getHours(),
                                            ).padStart(2, "0")}
                                            :
                                            {String(
                                                event.ticketDeadline.getMinutes(),
                                            ).padStart(2, "0")}
                                            )
                                        </span>
                                    )}
                                </Button>
                            ) : (
                                <button
                                    disabled
                                    class="w-full bg-zinc-800 text-zinc-500 font-bold text-lg py-4 rounded-2xl cursor-not-allowed border border-zinc-700"
                                >
                                    受付終了 (Deadline Passed)
                                </button>
                            )}
                        </div>
                    </div>
                )
            }
        </main>
    </div>
</Layout>

<style is:global>
    /* Markdown Styles (Previous styles preserved) */
    .prose h2 {
        @apply text-xl font-bold text-white mt-20 mb-8 font-en uppercase tracking-widest flex items-center gap-4;
    }
    .prose h2::before {
        content: "";
        @apply block w-2 h-8 bg-text-muted rounded-sm;
    }
    .prose h3 {
        @apply text-lg font-bold text-zinc-200 mt-12 mb-4 font-sans border-b border-subtle pb-2 inline-block pr-8;
    }
    .prose p {
        @apply text-zinc-400 leading-relaxed mb-6 font-sans text-base;
    }
    .prose ul {
        @apply list-none pl-0 space-y-0 my-8 ml-2 relative;
        border-left: none;
    }
    .prose ul li {
        @apply pl-0 py-4 relative flex items-baseline font-bold;
    }
    .prose ul li::after {
        content: "";
        @apply absolute left-[3px] w-[1px] bg-timeline;
        top: 0;
        height: 100%;
        z-index: 0;
    }
    .prose ul li:first-child::after {
        @apply top-6;
        height: calc(100% - 1.5rem);
    }
    .prose ul li:last-child::after {
        top: 0;
        @apply h-6;
    }
    .prose ul li::before {
        content: "";
        @apply absolute left-0 top-6 w-2 h-2 rounded-full bg-timeline ring-4 ring-zinc-950 transition-colors duration-300 z-10;
    }
    .prose ul li:hover::before {
        @apply bg-accent-blue;
    }
    .prose ul li strong {
        @apply text-white font-en text-lg leading-none mr-6 w-[80px] shrink-0 text-right;
    }
    /* Table Styles for Price List */
    .prose table {
        @apply w-full border-separate border-spacing-0 my-8 rounded-xl border border-zinc-700 overflow-hidden bg-surface;
    }
    .prose thead tr {
        @apply bg-zinc-800/50;
    }
    .prose th {
        @apply p-4 text-left font-bold border-b border-zinc-700 text-xs text-zinc-400 font-en tracking-widest uppercase;
    }
    .prose td {
        @apply p-4 border-b border-zinc-700/50 text-zinc-300 text-sm font-en;
    }
    .prose tr:last-child td {
        @apply border-b-0;
    }
    .prose td:not(:first-child),
    .prose th:not(:first-child) {
        @apply text-right;
    }
</style>
