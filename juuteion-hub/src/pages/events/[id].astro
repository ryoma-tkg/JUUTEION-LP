---
import Layout from "../../layouts/Layout.astro";
import Button from "../../components/ui/Button.astro";
import Tag from "../../components/ui/Tag.astro";
import SectionHeader from "../../components/ui/SectionHeader.astro";
import logo from "../../assets/logo/jto_logo.svg";

// ▼ Firebase & Markdown
import { db } from "../../lib/firebase/client";
import { collection, getDocs } from "firebase/firestore";
import { marked } from "marked";

import { getEventStatus } from "../../lib/utils/eventStatus";

interface EventData {
    id: string;
    title: string;
    subTitle?: string;
    date: Date;
    time: string;
    closeTime?: string;
    place: string;
    price: string;
    mainVisual: string;
    status?: string;
    body?: string;
    mapEmbed?: string;
    address?: string;
    ticketLink?: string;
    ticketDeadline?: Date;
}

interface Props {
    event: EventData;
}

export async function getStaticPaths() {
    const snapshot = await getDocs(collection(db, "events"));
    return snapshot.docs.map((doc) => {
        const data = doc.data();
        return {
            params: { id: doc.id },
            props: {
                event: {
                    id: doc.id,
                    ...data,
                    date: data.date?.toDate
                        ? data.date.toDate()
                        : new Date(data.date),
                    ticketDeadline: data.ticketDeadline?.toDate
                        ? data.ticketDeadline.toDate()
                        : data.ticketDeadline
                          ? new Date(data.ticketDeadline)
                          : null,
                } as EventData,
            },
        };
    });
}

const { event } = Astro.props;
const contentHtml = await marked.parse(event.body || "");

const formatDate = (date: Date) => {
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, "0");
    const d = String(date.getDate()).padStart(2, "0");
    const day = ["SUN", "MON", "TUE", "WED", "THU", "FRI", "SAT"][
        date.getDay()
    ];
    return `${y}.${m}.${d} ${day}`;
};

const statusData = getEventStatus(
    event.date,
    event.time,
    event.closeTime,
    event.status,
);

// ▼ 追加: TOPページと同じ背景スタイル生成ロジック
const getBgStyle = (imgUrl: string) => {
    if (imgUrl) return `background-image: url('${imgUrl}')`;
    return `background-color: #09090b; background-image: url('${logo.src}'); background-size: 30%; background-repeat: no-repeat; opacity: 0.5;`;
};
const bgStyle = getBgStyle(event.mainVisual);

const now = new Date();
const isDeadlinePassed = event.ticketDeadline
    ? now > event.ticketDeadline
    : false;
const canReserve = event.ticketLink && !isDeadlinePassed;
const isDev = import.meta.env.DEV;
---

<Layout title={event.title} isFluid={true}>
    <div class="flex flex-col lg:flex-row min-h-screen">
        {/* [LEFT COLUMN] Visual Only (PC) - TOPページ仕様に合わせる */}
        <aside
            class="hidden lg:block flex-1 h-screen sticky top-0 left-0 overflow-hidden border-r border-subtle min-w-0 bg-black"
        >
            <div
                class="absolute inset-0 bg-cover bg-center transition-all duration-700 hover:scale-105"
                style={bgStyle}
            >
            </div>
            <div class="absolute inset-0 bg-black/30"></div>
        </aside>

        {/* [RIGHT COLUMN] Content */}
        <main
            class="w-full lg:w-[700px] lg:shrink-0 bg-background relative z-10 border-l border-subtle"
        >
            <header
                class="lg:hidden flex justify-between items-center p-4 px-6 border-b border-subtle bg-background/80 backdrop-blur-md sticky top-0 z-50 h-16"
            >
                <a
                    href="/"
                    class="flex items-center gap-2 text-text-muted hover:text-white transition-colors relative z-10"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="20"
                        height="20"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        ><path d="m15 18-6-6 6-6"></path></svg
                    >
                    <span class="font-bold text-sm font-en">BACK</span>
                </a>
                <div
                    class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2"
                >
                    <img
                        src={logo.src}
                        alt="JUUTEION"
                        class="h-6 w-auto opacity-90"
                    />
                </div>
            </header>

            {/* Hero Section */}
            <div
                class="relative w-full bg-zinc-900 group border-b border-subtle overflow-hidden"
            >
                {
                    event.mainVisual ? (
                        <img
                            src={event.mainVisual}
                            alt={event.title}
                            class="w-full h-auto block"
                        />
                    ) : (
                        <div class="w-full aspect-[4/5] lg:aspect-[16/10] bg-zinc-950 flex items-center justify-center relative overflow-hidden">
                            <img src={logo.src} class="w-1/3 opacity-20" />
                        </div>
                    )
                }

                <div
                    class="absolute bottom-0 left-0 right-0 h-2/3 bg-gradient-to-t from-background via-background/80 to-transparent"
                >
                </div>

                {
                    isDev && (
                        <div class="absolute top-4 right-4 z-50">
                            <a
                                href={`/admin/edit?id=${event.id}`}
                                class="text-[10px] bg-white text-black font-bold px-3 py-1.5 rounded-full hover:bg-zinc-200 transition-colors"
                            >
                                ✎ EDIT
                            </a>
                        </div>
                    )
                }

                <div
                    class="absolute bottom-0 left-0 w-full p-8 md:p-12 flex flex-col justify-end z-20"
                >
                    <div class="space-y-4">
                        <h1
                            class="flex flex-col md:flex-row md:items-baseline flex-wrap gap-x-4 gap-y-1 font-bold tracking-tighter leading-none font-en"
                        >
                            <span class="text-5xl lg:text-6xl text-white"
                                >{event.title}</span
                            >
                            <span
                                class="text-2xl lg:text-3xl text-zinc-500 font-normal tracking-normal pb-1"
                                >{event.subTitle}</span
                            >
                        </h1>
                        <div
                            class="flex flex-wrap items-center gap-x-6 gap-y-2 text-sm font-bold text-white tracking-widest font-en pt-2"
                        >
                            <div class="flex items-center gap-2">
                                <Tag
                                    variant={statusData.color as any}
                                    class="font-en">{statusData.label}</Tag
                                >
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {/* Inner Content */}
            <div class="w-full px-8 md:px-12 py-12 lg:py-16 pb-32 space-y-16">
                <section>
                    <SectionHeader
                        title="Event Info"
                        accentColor="muted"
                        class="mb-6"
                    />
                    <div
                        class="bg-surface border border-subtle rounded-2xl p-6 space-y-4"
                    >
                        {/* DATE */}
                        <div class="flex items-start gap-5">
                            <div
                                class="w-8 flex justify-center text-accent-blue mt-0.5"
                            >
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    width="20"
                                    height="20"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    ><rect
                                        width="18"
                                        height="18"
                                        x="3"
                                        y="4"
                                        rx="2"
                                        ry="2"></rect><line
                                        x1="16"
                                        x2="16"
                                        y1="2"
                                        y2="6"></line><line
                                        x1="8"
                                        x2="8"
                                        y1="2"
                                        y2="6"></line><line
                                        x1="3"
                                        x2="21"
                                        y1="10"
                                        y2="10"></line></svg
                                >
                            </div>
                            <div>
                                <p
                                    class="text-[10px] text-zinc-500 font-bold tracking-widest font-en mb-1"
                                >
                                    DATE
                                </p>
                                <p class="text-lg font-bold text-white font-en">
                                    {formatDate(event.date)}
                                </p>
                                <p class="text-sm text-text-muted font-en">
                                    {event.time}
                                </p>
                            </div>
                        </div>
                        <div class="w-full h-px bg-zinc-800"></div>
                        {/* PLACE */}
                        <div class="flex items-start gap-5">
                            <div
                                class="w-8 flex justify-center text-accent-red mt-0.5"
                            >
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    width="20"
                                    height="20"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    ><path
                                        d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"
                                    ></path><circle cx="12" cy="10" r="3"
                                    ></circle></svg
                                >
                            </div>
                            <div>
                                <p
                                    class="text-[10px] text-zinc-500 font-bold tracking-widest font-en mb-1"
                                >
                                    PLACE
                                </p>
                                <p class="text-lg font-bold text-white font-en">
                                    {event.place}
                                </p>
                            </div>
                        </div>
                        <div class="w-full h-px bg-zinc-800"></div>
                        {/* PRICE */}
                        <div class="flex items-start gap-5">
                            <div
                                class="w-8 flex justify-center text-accent-yellow mt-0.5"
                            >
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    width="20"
                                    height="20"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    ><rect
                                        width="20"
                                        height="12"
                                        x="2"
                                        y="6"
                                        rx="2"></rect><circle
                                        cx="12"
                                        cy="12"
                                        r="2"></circle><path d="M6 12h.01"
                                    ></path><path d="M18 12h.01"></path></svg
                                >
                            </div>
                            <div>
                                <p
                                    class="text-[10px] text-zinc-500 font-bold tracking-widest font-en mb-1"
                                >
                                    PRICE
                                </p>
                                <p class="text-lg font-bold text-white font-en">
                                    {event.price}
                                </p>
                            </div>
                        </div>
                    </div>
                </section>

                {/* Markdown Body */}
                <div
                    id="event-body"
                    class="prose prose-invert prose-sm md:prose-base max-w-none"
                    data-event-date={event.date.toISOString()}
                >
                    <Fragment set:html={contentHtml} />
                </div>

                {
                    event.mapEmbed && (
                        <section id="access">
                            <SectionHeader
                                title="Access"
                                accentColor="muted"
                                class="mb-6"
                            />
                            <div class="space-y-4">
                                <div class="w-full aspect-video rounded-2xl overflow-hidden border border-subtle bg-surface relative group">
                                    <iframe
                                        src={event.mapEmbed}
                                        width="100%"
                                        height="100%"
                                        style="border:0; filter: grayscale(100%) invert(92%) hue-rotate(180deg) contrast(90%);"
                                        allowfullscreen=""
                                        loading="lazy"
                                        referrerpolicy="no-referrer-when-downgrade"
                                        class="w-full h-full opacity-70 group-hover:opacity-100 transition-opacity duration-500"
                                    />
                                    <div class="absolute inset-0 pointer-events-none border border-white/5 rounded-2xl" />
                                </div>
                                <div class="flex items-start justify-between gap-4 px-2">
                                    <div>
                                        <p class="text-lg font-bold text-white font-en">
                                            {event.place}
                                        </p>
                                        {event.address && (
                                            <p class="text-sm text-text-muted mt-1 font-sans">
                                                {event.address}
                                            </p>
                                        )}
                                    </div>
                                    <a
                                        href={`http://maps.google.com/maps?q=${encodeURIComponent(event.place + " " + (event.address || ""))}`}
                                        target="_blank"
                                        rel="noopener noreferrer"
                                        class="text-xs font-bold font-en text-accent-blue hover:text-white transition-colors border-b border-accent-blue/30 pb-0.5"
                                    >
                                        OPEN MAP →
                                    </a>
                                </div>
                            </div>
                        </section>
                    )
                }

                {/* JOIN THE FLOOR (Updated) */}
                <section
                    id="social-bottom"
                    class="space-y-10 pt-10 border-t border-subtle"
                >
                    <SectionHeader
                        title="Join the Floor"
                        accentColor="subtle"
                        titleClass="text-white"
                    />
                    {/* Grid Layout: 3 items (X, Instagram, VRC) */}
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        {/* 1. X */}
                        <a
                            href="#"
                            class="group bg-surface border border-subtle hover:border-accent-blue/50 rounded-2xl p-6 flex items-center justify-between transition-colors duration-300"
                        >
                            <div class="flex items-center gap-4">
                                <div
                                    class="w-10 h-10 rounded-full bg-black flex items-center justify-center text-zinc-500 group-hover:text-white transition-colors border border-subtle group-hover:border-accent-blue/30"
                                >
                                    <svg
                                        xmlns="http://www.w3.org/2000/svg"
                                        width="18"
                                        height="18"
                                        viewBox="0 0 24 24"
                                        fill="currentColor"
                                        ><path
                                            d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"
                                        ></path></svg>
                                </div>
                                <div>
                                    <p
                                        class="text-sm font-bold text-text-main font-en tracking-wide"
                                    >
                                        Official X
                                    </p><p
                                        class="text-[10px] text-text-muted mt-0.5 font-en"
                                    >
                                        Latest Information
                                    </p>
                                </div>
                            </div>
                            <span
                                class="text-[10px] text-subtle group-hover:text-accent-blue transition-colors font-en"
                                >VIEW →</span
                            >
                        </a>

                        {/* 2. Instagram (★NEW ADDITION) */}
                        <a
                            href="#"
                            class="group bg-surface border border-subtle hover:border-accent-red/50 rounded-2xl p-6 flex items-center justify-between transition-colors duration-300"
                        >
                            <div class="flex items-center gap-4">
                                <div
                                    class="w-10 h-10 rounded-full bg-black flex items-center justify-center text-zinc-500 group-hover:text-white transition-colors border border-subtle group-hover:border-accent-red/30"
                                >
                                    <svg
                                        xmlns="http://www.w3.org/2000/svg"
                                        width="20"
                                        height="20"
                                        viewBox="0 0 24 24"
                                        fill="none"
                                        stroke="currentColor"
                                        stroke-width="2"
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        ><rect
                                            width="20"
                                            height="20"
                                            x="2"
                                            y="2"
                                            rx="5"
                                            ry="5"></rect><path
                                            d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"
                                        ></path><line
                                            x1="17.5"
                                            x2="17.51"
                                            y1="6.5"
                                            y2="6.5"></line></svg>
                                </div>
                                <div>
                                    <p
                                        class="text-sm font-bold text-text-main font-en tracking-wide"
                                    >
                                        Instagram
                                    </p><p
                                        class="text-[10px] text-text-muted mt-0.5 font-en"
                                    >
                                        Photo Archive
                                    </p>
                                </div>
                            </div>
                            <span
                                class="text-[10px] text-subtle group-hover:text-accent-red transition-colors font-en"
                                >VIEW →</span
                            >
                        </a>

                        {/* 3. VRChat (Span 2 cols on PC) */}
                        <a
                            href="#"
                            class="sm:col-span-2 group bg-surface border border-subtle hover:border-accent-yellow/50 rounded-2xl p-6 flex items-center justify-between transition-colors duration-300"
                        >
                            <div class="flex items-center gap-4">
                                <div
                                    class="w-10 h-10 rounded-full bg-black flex items-center justify-center text-zinc-500 group-hover:text-white transition-colors border border-subtle group-hover:border-accent-yellow/30"
                                >
                                    <span class="font-bold text-xs font-en"
                                        >VRC</span>
                                </div>
                                <div>
                                    <p
                                        class="text-sm font-bold text-text-main font-en tracking-wide"
                                    >
                                        VRChat Group
                                    </p><p
                                        class="text-[10px] text-text-muted mt-0.5 font-en"
                                    >
                                        Join the virtual venue
                                    </p>
                                </div>
                            </div>
                            <span
                                class="text-[10px] text-subtle group-hover:text-accent-yellow transition-colors font-en"
                                >JOIN →</span
                            >
                        </a>
                    </div>
                </section>
            </div>

            {/* Footer Sticky Button */}
            {
                statusData.isLive && event.ticketLink && (
                    <div class="sticky bottom-0 left-0 right-0 z-50 p-6 pb-8 bg-gradient-to-t from-background via-background to-transparent pointer-events-none">
                        <div class="w-full pointer-events-auto">
                            {canReserve ? (
                                <Button
                                    variant="primary"
                                    href={event.ticketLink}
                                    class="w-full"
                                >
                                    TwiPlaで参加表明する
                                    {event.ticketDeadline && (
                                        <span class="text-[10px] ml-2 opacity-70 font-normal">
                                            (〆{" "}
                                            {event.ticketDeadline.getMonth() +
                                                1}
                                            /{event.ticketDeadline.getDate()}{" "}
                                            {String(
                                                event.ticketDeadline.getHours(),
                                            ).padStart(2, "0")}
                                            :
                                            {String(
                                                event.ticketDeadline.getMinutes(),
                                            ).padStart(2, "0")}
                                            )
                                        </span>
                                    )}
                                </Button>
                            ) : (
                                <button
                                    disabled
                                    class="w-full bg-zinc-800 text-zinc-500 font-bold text-lg py-4 rounded-xl cursor-not-allowed border border-zinc-700"
                                >
                                    受付終了 (Deadline Passed)
                                </button>
                            )}
                        </div>
                    </div>
                )
            }
        </main>
    </div>
</Layout>

<script>
    document.addEventListener("astro:page-load", () => {
        const body = document.getElementById("event-body");
        if (!body) return;

        const eventDateStr = body.getAttribute("data-event-date");
        if (!eventDateStr) return;

        const eventDate = new Date(eventDateStr);
        const now = new Date();
        const isSameDay =
            eventDate.getFullYear() === now.getFullYear() &&
            eventDate.getMonth() === now.getMonth() &&
            eventDate.getDate() === now.getDate();
        if (!isSameDay) return;

        const items = body.querySelectorAll("ul li");
        let currentItem: HTMLElement | null = null;
        const currentMinutes = now.getHours() * 60 + now.getMinutes();
        items.forEach((item) => {
            const timeStr = item.querySelector("strong")?.innerText;
            if (timeStr) {
                const [h, m] = timeStr.split(":").map(Number);
                const itemMinutes = h * 60 + m;
                if (itemMinutes <= currentMinutes) {
                    currentItem = item as HTMLElement;
                }
            }
        });
        if (currentItem) {
            (currentItem as HTMLElement).classList.add("active");
        }
    });
</script>
