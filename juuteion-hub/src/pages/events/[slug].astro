---
import { getCollection } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import Button from "../../components/ui/Button.astro";
import Tag from "../../components/ui/Tag.astro";
import HamburgerMenu from "../../components/ui/HamburgerMenu.astro";

// 1. 全てのイベント記事を取得し、パス（URL）を生成する
export async function getStaticPaths() {
    const events = await getCollection("events");
    return events.map((entry) => ({
        params: { slug: entry.slug },
        props: { entry },
    }));
}

// 2. 記事データを取得
const { entry } = Astro.props;
const { Content } = await entry.render();

// ユーティリティ: 日付フォーマット
const formatDate = (date) => {
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, "0");
    const d = String(date.getDate()).padStart(2, "0");
    const day = ["SUN", "MON", "TUE", "WED", "THU", "FRI", "SAT"][
        date.getDay()
    ];
    return `${y}.${m}.${d} ${day}`;
};
---

<Layout title={entry.data.title} isFluid={true}>
    <HamburgerMenu />

    <div class="flex flex-col lg:flex-row min-h-screen">
        {/* [LEFT COLUMN] Visual Only (PC) */}
        <aside
            class="hidden lg:block flex-1 h-screen sticky top-0 left-0 overflow-hidden border-r border-subtle min-w-0"
        >
            <div
                class="absolute inset-0 bg-cover bg-center"
                style={`background-image: url('${entry.data.image}')`}
            >
                <div class="absolute inset-0 bg-black/20"></div>
            </div>
        </aside>

        {/* [RIGHT COLUMN] Content */}
        <main
            class="w-full lg:w-[700px] lg:shrink-0 bg-background relative z-10 border-l border-subtle"
        >
            {/* Mobile Header (Back Button) */}
            <header
                class="lg:hidden flex justify-between items-center p-6 border-b border-subtle bg-background/80 backdrop-blur-md sticky top-0 z-30"
            >
                <a
                    href="/"
                    class="flex items-center gap-2 text-text-muted hover:text-white transition-colors"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="20"
                        height="20"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        ><path d="m15 18-6-6 6-6"></path></svg
                    >
                    <span class="font-bold text-sm font-en">BACK</span>
                </a>
            </header>

            {/* Mobile Hero Image (Hidden on PC) */}
            <div
                class="lg:hidden relative w-full aspect-video bg-zinc-800 group overflow-hidden border-b border-subtle"
            >
                <div
                    class="absolute inset-0 bg-cover bg-center"
                    style={`background-image: url('${entry.data.image}')`}
                >
                </div>
                <div
                    class="absolute inset-0 bg-gradient-to-t from-background via-transparent to-transparent opacity-90"
                >
                </div>
            </div>

            {/* Inner Content Wrapper */}
            <div class="w-full px-8 md:px-12 py-12 lg:py-24 pb-32 space-y-12">
                {/* Title Section */}
                <div class="space-y-6">
                    <div>
                        <Tag
                            variant="yellow"
                            class="mb-3 font-en shadow-lg shadow-accent-yellow/10"
                            >EVENT INFO</Tag
                        >
                        <h1
                            class="text-4xl lg:text-5xl font-bold text-white tracking-tighter leading-[1.1] mb-2 font-en"
                        >
                            {entry.data.title}<br />
                            <span
                                class="text-accent-blue text-2xl lg:text-3xl block mt-2"
                                >{entry.data.subTitle}</span
                            >
                        </h1>
                    </div>

                    {/* Info Grid (Bento Style) */}
                    <div
                        class="bg-surface border border-subtle rounded-2xl p-6 space-y-4 shadow-lg"
                    >
                        {/* DATE */}
                        <div class="flex items-start gap-5">
                            <div
                                class="w-8 flex justify-center text-accent-blue mt-0.5"
                            >
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    width="20"
                                    height="20"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    ><rect
                                        width="18"
                                        height="18"
                                        x="3"
                                        y="4"
                                        rx="2"
                                        ry="2"></rect><line
                                        x1="16"
                                        x2="16"
                                        y1="2"
                                        y2="6"></line><line
                                        x1="8"
                                        x2="8"
                                        y1="2"
                                        y2="6"></line><line
                                        x1="3"
                                        x2="21"
                                        y1="10"
                                        y2="10"></line></svg
                                >
                            </div>
                            <div>
                                <p
                                    class="text-xs text-text-muted font-bold tracking-widest font-en mb-1"
                                >
                                    DATE
                                </p>
                                <p class="text-lg font-bold text-white font-en">
                                    {formatDate(entry.data.date)}
                                </p>
                                <p class="text-sm text-text-muted font-en">
                                    {entry.data.time}
                                </p>
                            </div>
                        </div>
                        <div class="w-full h-px bg-subtle"></div>

                        {/* PLACE */}
                        <div class="flex items-start gap-5">
                            <div
                                class="w-8 flex justify-center text-accent-red mt-0.5"
                            >
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    width="20"
                                    height="20"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    ><path
                                        d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"
                                    ></path><circle cx="12" cy="10" r="3"
                                    ></circle></svg
                                >
                            </div>
                            <div>
                                <p
                                    class="text-xs text-text-muted font-bold tracking-widest font-en mb-1"
                                >
                                    PLACE
                                </p>
                                <p class="text-lg font-bold text-white font-en">
                                    {entry.data.place}
                                </p>
                            </div>
                        </div>
                        <div class="w-full h-px bg-subtle"></div>

                        {/* PRICE */}
                        <div class="flex items-start gap-5">
                            <div
                                class="w-8 flex justify-center text-accent-yellow mt-0.5"
                            >
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    width="20"
                                    height="20"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    ><rect
                                        width="20"
                                        height="12"
                                        x="2"
                                        y="6"
                                        rx="2"></rect><circle
                                        cx="12"
                                        cy="12"
                                        r="2"></circle><path d="M6 12h.01"
                                    ></path><path d="M18 12h.01"></path></svg
                                >
                            </div>
                            <div>
                                <p
                                    class="text-xs text-text-muted font-bold tracking-widest font-en mb-1"
                                >
                                    PRICE
                                </p>
                                <p class="text-lg font-bold text-white font-en">
                                    {entry.data.price}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                {/* Markdown Content Body */}
                <div
                    class="prose prose-invert prose-sm md:prose-base max-w-none pt-8 border-t border-subtle"
                >
                    <Content />
                </div>
            </div>

            {/* Sticky Footer CTA (Right Column Only) */}
            <div
                class="sticky bottom-0 left-0 right-0 z-50 p-6 bg-gradient-to-t from-black via-black/95 to-transparent border-t border-white/5 backdrop-blur-sm"
            >
                <div class="w-full">
                    <Button
                        variant="primary"
                        href={`/events/${entry.slug}/ticket`}
                        class="shadow-xl shadow-accent-blue/20 w-full"
                    >
                        チケットを予約する
                    </Button>
                </div>
            </div>
        </main>
    </div>
</Layout>

<style is:global>
    /* === Markdown Custom Styling === */

    /* Headers */
    .prose h2 {
        @apply text-xl md:text-2xl font-bold text-white mt-12 mb-6 font-en flex items-center gap-3 border-l-4 border-accent-blue pl-4;
    }
    /* Reset default before if exists in typography plugin */
    .prose h2::before {
        content: none;
    }

    .prose h3 {
        @apply text-lg md:text-xl font-bold text-zinc-200 mt-10 mb-4 font-sans border-b border-zinc-800 pb-2;
    }
    .prose p {
        @apply text-zinc-400 leading-relaxed mb-6 font-sans text-base;
    }

    /* Timeline Style (Unordered List) */
    .prose ul {
        @apply list-none pl-0 space-y-0 my-8 border-l-2 border-zinc-800 ml-2;
    }
    .prose ul li {
        @apply pl-6 py-4 relative border-b border-zinc-800/50 last:border-0;
    }
    .prose ul li::before {
        content: "";
        @apply absolute left-[-5px] top-6 w-2.5 h-2.5 rounded-full bg-zinc-600 ring-4 ring-zinc-950 transition-colors duration-300;
    }
    .prose ul li:hover::before {
        @apply bg-accent-blue;
    }
    .prose ul li strong {
        @apply text-white font-en block text-lg leading-none mb-1;
    }

    /* Price Table Style */
    .prose table {
        @apply w-full border-separate border-spacing-0 my-8 rounded-xl border border-zinc-700 overflow-hidden bg-surface;
    }
    .prose thead tr {
        @apply bg-zinc-800/50;
    }
    .prose th {
        @apply p-4 text-left font-bold border-b border-zinc-700 text-xs text-zinc-400 font-en tracking-widest uppercase;
    }
    .prose td {
        @apply p-4 border-b border-zinc-700/50 text-zinc-300 text-sm font-en;
    }
    .prose tr:last-child td {
        @apply border-b-0;
    }
    .prose td:not(:first-child),
    .prose th:not(:first-child) {
        @apply text-right;
    }

    /* Images */
    .prose img {
        @apply rounded-xl border border-zinc-800 w-full shadow-lg;
    }

    /* Blockquote */
    .prose blockquote {
        @apply border-l-4 border-accent-yellow bg-accent-yellow/5 p-4 rounded-r-lg not-italic text-zinc-300 my-6;
    }
</style>
