---
import "@fontsource/ibm-plex-sans-jp/400.css";
import "@fontsource/ibm-plex-sans-jp/700.css";
import "@fontsource/montserrat/400.css";
import "@fontsource/montserrat/700.css";

// â–¼ ä¿®æ­£: Astro v5å¯¾å¿œ (ViewTransitions -> ClientRouter)
import { ClientRouter } from "astro:transitions";

interface Props {
    title: string;
}

const { title } = Astro.props;
---

<!doctype html>
<html lang="ja" class="dark">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width" />
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
        <meta name="generator" content={Astro.generator} />
        <title>{title} | JUUTEION Admin</title>

        {/* â–¼ ä¿®æ­£: ClientRouterã‚’è¿½åŠ  */}
        <ClientRouter />
    </head>
    <body
        class="bg-zinc-950 text-zinc-100 antialiased min-h-screen flex flex-col"
    >
        {/* Admin Header */}
        <header
            class="bg-zinc-900 border-b border-zinc-800 px-6 py-4 flex justify-between items-center"
        >
            <h1
                class="font-en font-bold text-lg tracking-widest text-accent-blue"
            >
                JUUTEION <span class="text-white">ADMIN</span>
            </h1>

            {/* â–¼ ä¿®æ­£: åˆæœŸçŠ¶æ…‹ã¯ hidden ã®ã¿ (flexã¯JSã§è¿½åŠ ) */}
            <div id="user-info" class="hidden items-center gap-4">
                <span id="user-email" class="text-sm text-zinc-400 font-mono"
                ></span>

                {/* ã‚µã‚¤ãƒˆæ›´æ–°ãƒœã‚¿ãƒ³ */}
                <button
                    id="deploy-btn"
                    class="text-xs bg-accent-blue/10 text-accent-blue border border-accent-blue/30 px-3 py-1.5 rounded hover:bg-accent-blue/20 transition-colors flex items-center gap-2"
                >
                    <span
                        class="w-2 h-2 rounded-full bg-accent-blue animate-pulse"
                    ></span>
                    PUBLISH SITE
                </button>

                <div class="h-4 w-px bg-zinc-700 mx-2"></div>

                <button
                    id="logout-btn"
                    class="text-xs border border-zinc-700 px-3 py-1.5 rounded hover:bg-zinc-800 transition-colors"
                >
                    LOGOUT
                </button>
            </div>
        </header>

        <main class="flex-1 p-6 overflow-auto">
            <slot />
        </main>

        <script>
            import { auth } from "../lib/firebase/client";
            import { onAuthStateChanged, signOut } from "firebase/auth";

            console.log("ğŸš€ AdminLayout script loaded");

            const initAuth = () => {
                console.log("ğŸ”„ initAuth checking...");

                const userEmailSpan = document.getElementById("user-email");
                const userInfoDiv = document.getElementById("user-info");
                const logoutBtn = document.getElementById("logout-btn");
                const deployBtn = document.getElementById("deploy-btn");

                const GITHUB_TOKEN = import.meta.env.PUBLIC_GITHUB_TOKEN;
                const GITHUB_REPO = import.meta.env.PUBLIC_GITHUB_REPO;

                const ALLOWED_EMAILS = [
                    "takagi.buckup@gmail.com",
                    "juuteion.events@gmail.com",
                ];

                // Authã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯ (ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°ã«ç¢ºä¿)
                const authInstance = auth;

                if (authInstance) {
                    onAuthStateChanged(authInstance, (user) => {
                        console.log(
                            "ğŸ‘¤ Auth State Changed:",
                            user ? user.email : "Logged out",
                        );
                        const currentPath = window.location.pathname;

                        if (user) {
                            // ãƒ­ã‚°ã‚¤ãƒ³ä¸­
                            if (!ALLOWED_EMAILS.includes(user.email || "")) {
                                alert("ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
                                signOut(authInstance);
                                return;
                            }

                            if (userEmailSpan)
                                userEmailSpan.innerText = user.email || "";

                            // â–¼ ä¿®æ­£: è¡¨ç¤ºæ™‚ã« flex ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
                            if (userInfoDiv) {
                                userInfoDiv.classList.remove("hidden");
                                userInfoDiv.classList.add("flex");
                            }

                            // ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ã„ã‚‹å ´åˆã¯ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¸
                            if (currentPath === "/admin/login") {
                                window.location.href = "/admin";
                            }
                        } else {
                            // æœªãƒ­ã‚°ã‚¤ãƒ³
                            if (currentPath !== "/admin/login") {
                                console.log("âš ï¸ Redirecting to login...");
                                window.location.href = "/admin/login";
                            }
                        }
                    });

                    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
                    logoutBtn?.addEventListener("click", async () => {
                        await signOut(authInstance);
                        window.location.href = "/admin/login";
                    });

                    // ã‚µã‚¤ãƒˆæ›´æ–°ï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤ï¼‰å‡¦ç†
                    deployBtn?.addEventListener("click", async () => {
                        if (
                            !confirm(
                                "æœ¬ç•ªã‚µã‚¤ãƒˆã‚’æ›´æ–°ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆå®Œäº†ã¾ã§æ•°åˆ†ã‹ã‹ã‚Šã¾ã™ï¼‰",
                            )
                        )
                            return;

                        if (!GITHUB_TOKEN || !GITHUB_REPO) {
                            alert("GitHubè¨­å®š(.env)ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚");
                            return;
                        }

                        deployBtn.setAttribute("disabled", "true");
                        deployBtn.innerText = "REQUESTING...";

                        try {
                            const res = await fetch(
                                `https://api.github.com/repos/${GITHUB_REPO}/dispatches`,
                                {
                                    method: "POST",
                                    headers: {
                                        Accept: "application/vnd.github.v3+json",
                                        Authorization: `token ${GITHUB_TOKEN}`,
                                    },
                                    body: JSON.stringify({
                                        event_type: "publish_event",
                                    }),
                                },
                            );

                            if (res.ok) {
                                alert(
                                    "æ›´æ–°ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¾ã—ãŸï¼\næ•°åˆ†å¾Œã«æœ¬ç•ªã‚µã‚¤ãƒˆãŒæ›´æ–°ã•ã‚Œã¾ã™ã€‚",
                                );
                            } else {
                                throw new Error(`Status: ${res.status}`);
                            }
                        } catch (e) {
                            console.error(e);
                            alert("ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: " + e);
                        } finally {
                            deployBtn.removeAttribute("disabled");
                            deployBtn.innerHTML =
                                '<span class="w-2 h-2 rounded-full bg-accent-blue animate-pulse"></span> PUBLISH SITE';
                        }
                    });
                } else {
                    // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã§AuthãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ãªã„å ´åˆ
                    console.error(
                        "âŒ Firebase Auth not initialized in client context.",
                    );
                }
            };

            // View Transitions (ClientRouter) å¯¾å¿œ: ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ¯ã«å®Ÿè¡Œ
            document.addEventListener("astro:page-load", initAuth);
        </script>
    </body>
</html>
