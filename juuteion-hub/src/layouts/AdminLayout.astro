<script>
    // â–¼ å¿…è¦ãªãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ã™ã¹ã¦ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
    import { auth, functions } from "../lib/firebase/client"; // functionsã‚’è¿½åŠ 
    import { onAuthStateChanged, signOut } from "firebase/auth";
    import { httpsCallable } from "firebase/functions"; // ã“ã‚Œã‚’è¿½åŠ 

    console.log("ğŸš€ AdminLayout script loaded");

    const initAuth = () => {
        console.log("ğŸ”„ initAuth checking...");

        // â–¼ DOMè¦ç´ ã®å–å¾—ï¼ˆã“ã“ãŒæ¶ˆãˆã¦ã„ãŸãŸã‚ã‚¨ãƒ©ãƒ¼ã«ãªã£ã¦ã„ã¾ã—ãŸï¼‰
        const userEmailSpan = document.getElementById("user-email");
        const userInfoDiv = document.getElementById("user-info");
        const logoutBtn = document.getElementById("logout-btn");
        const deployBtn = document.getElementById("deploy-btn"); // ã“ã‚ŒãŒå¿…è¦ã§ã™

        const ALLOWED_EMAILS = [
            "takagi.buckup@gmail.com",
            "juuteion.events@gmail.com",
        ];

        const authInstance = auth;
        if (authInstance) {
            onAuthStateChanged(authInstance, (user) => {
                const currentPath = window.location.pathname;

                if (user) {
                    if (!ALLOWED_EMAILS.includes(user.email || "")) {
                        alert("ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
                        signOut(authInstance);
                        return;
                    }

                    if (userEmailSpan)
                        userEmailSpan.innerText = user.email || "";
                    if (userInfoDiv) {
                        userInfoDiv.classList.remove("hidden");
                        userInfoDiv.classList.add("flex");
                    }

                    if (currentPath === "/admin/login") {
                        window.location.href = "/admin";
                    }
                } else {
                    if (currentPath !== "/admin/login") {
                        window.location.href = "/admin/login";
                    }
                }
            });

            logoutBtn?.addEventListener("click", async () => {
                await signOut(authInstance);
                window.location.href = "/admin/login";
            });

            deployBtn?.addEventListener("click", async () => {
                if (
                    !confirm(
                        "æœ¬ç•ªã‚µã‚¤ãƒˆã‚’æ›´æ–°ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆå®Œäº†ã¾ã§æ•°åˆ†ã‹ã‹ã‚Šã¾ã™ï¼‰",
                    )
                )
                    return;

                // deployBtnãŒnullã§ãªã„ã“ã¨ã‚’ç¢ºèªã—ã¦ã‹ã‚‰å±æ€§ã‚’æ“ä½œ
                if (!deployBtn) return;

                deployBtn.setAttribute("disabled", "true");
                const originalText = deployBtn.innerHTML; // å…ƒã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ä¿å­˜
                deployBtn.innerText = "REQUESTING...";

                try {
                    // Cloud Functions ã®é–¢æ•°å‘¼ã³å‡ºã—
                    // ãƒªãƒ¼ã‚¸ãƒ§ãƒ³æŒ‡å®šã‚’å‰Šé™¤ã—ãŸã®ã§ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ¡ã‚½ãƒƒãƒ‰ã§å‘¼ã³å‡ºã›ã¾ã™
                    const triggerDeploy = httpsCallable(
                        functions,
                        "triggerGithubDispatch",
                    );

                    const result = await triggerDeploy();
                    const data = result.data as any;

                    console.log("Deploy Result:", data);
                    alert(
                        "æ›´æ–°ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¾ã—ãŸï¼\næ•°åˆ†å¾Œã«æœ¬ç•ªã‚µã‚¤ãƒˆãŒæ›´æ–°ã•ã‚Œã¾ã™ã€‚",
                    );
                } catch (e: any) {
                    console.error(e);
                    alert("ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: " + e.message);
                } finally {
                    deployBtn.removeAttribute("disabled");
                    deployBtn.innerHTML =
                        '<span class="w-2 h-2 rounded-full bg-accent-blue animate-pulse"></span> PUBLISH SITE';
                }
            });
        } else {
            console.error(
                "âŒ Firebase Auth not initialized in client context.",
            );
        }
    };

    document.addEventListener("astro:page-load", initAuth);
</script>
