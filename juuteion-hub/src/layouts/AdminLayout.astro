---
import "@fontsource/ibm-plex-sans-jp/400.css";
import "@fontsource/ibm-plex-sans-jp/700.css";
import "@fontsource/montserrat/400.css";
import "@fontsource/montserrat/700.css";
import "../styles/global.css";

import { ClientRouter } from "astro:transitions";

interface Props {
    title: string;
}

const { title } = Astro.props;
---

<!doctype html>
<html lang="ja" class="dark">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width" />
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
        <meta name="generator" content={Astro.generator} />
        <title>{title} | JUUTEION Admin</title>
        <ClientRouter />
    </head>
    <body
        class="bg-zinc-950 text-zinc-100 antialiased min-h-screen flex flex-col"
    >
        <header
            class="bg-zinc-900 border-b border-zinc-800 px-6 py-4 flex justify-between items-center"
        >
            <div class="flex items-center gap-6">
                <h1
                    class="font-en font-bold text-lg tracking-widest text-accent-blue"
                >
                    JUUTEION <span class="text-white">ADMIN</span>
                </h1>

                <a
                    href="/"
                    class="text-xs text-zinc-500 hover:text-white flex items-center gap-1 transition-colors"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="14"
                        height="14"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        ><path d="m15 18-6-6 6-6"></path></svg
                    >
                    BACK TO SITE
                </a>
            </div>

            <div id="user-info" class="hidden items-center gap-4">
                <span id="user-email" class="text-sm text-zinc-400 font-mono"
                ></span>
                <button
                    id="deploy-btn"
                    class="text-xs bg-accent-blue/10 text-accent-blue border border-accent-blue/30 px-3 py-1.5 rounded hover:bg-accent-blue/20 transition-colors flex items-center gap-2"
                >
                    <span
                        class="w-2 h-2 rounded-full bg-accent-blue animate-pulse"
                    ></span>
                    PUBLISH SITE
                </button>
                <div class="h-4 w-px bg-zinc-700 mx-2"></div>
                <button
                    id="logout-btn"
                    class="text-xs border border-zinc-700 px-3 py-1.5 rounded hover:bg-zinc-800 transition-colors"
                    >LOGOUT</button
                >
            </div>
        </header>

        <main class="flex-1 p-6 overflow-auto">
            <slot />
        </main>

        <script>
            import { auth } from "../lib/firebase/client";
            import { onAuthStateChanged, signOut } from "firebase/auth";

            console.log("ğŸš€ AdminLayout script loaded");
            const initAuth = () => {
                console.log("ğŸ”„ initAuth checking...");
                const userEmailSpan = document.getElementById("user-email");
                const userInfoDiv = document.getElementById("user-info");
                const logoutBtn = document.getElementById("logout-btn");
                const deployBtn = document.getElementById("deploy-btn");

                const GITHUB_TOKEN = import.meta.env.PUBLIC_GITHUB_TOKEN;
                const GITHUB_REPO = import.meta.env.PUBLIC_GITHUB_REPO;

                const ALLOWED_EMAILS = [
                    "takagi.buckup@gmail.com",
                    "juuteion.events@gmail.com",
                ];

                const authInstance = auth;
                if (authInstance) {
                    onAuthStateChanged(authInstance, (user) => {
                        const currentPath = window.location.pathname;

                        if (user) {
                            if (!ALLOWED_EMAILS.includes(user.email || "")) {
                                alert("ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
                                signOut(authInstance);
                                return;
                            }

                            if (userEmailSpan)
                                userEmailSpan.innerText = user.email || "";
                            if (userInfoDiv) {
                                userInfoDiv.classList.remove("hidden");
                                userInfoDiv.classList.add("flex");
                            }

                            if (currentPath === "/admin/login") {
                                window.location.href = "/admin";
                            }
                        } else {
                            if (currentPath !== "/admin/login") {
                                window.location.href = "/admin/login";
                            }
                        }
                    });

                    logoutBtn?.addEventListener("click", async () => {
                        await signOut(authInstance);
                        window.location.href = "/admin/login";
                    });

                    deployBtn?.addEventListener("click", async () => {
                        if (
                            !confirm(
                                "æœ¬ç•ªã‚µã‚¤ãƒˆã‚’æ›´æ–°ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆå®Œäº†ã¾ã§æ•°åˆ†ã‹ã‹ã‚Šã¾ã™ï¼‰",
                            )
                        )
                            return;

                        if (!GITHUB_TOKEN || !GITHUB_REPO) {
                            alert("GitHubè¨­å®š(.env)ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚");
                            return;
                        }

                        deployBtn.setAttribute("disabled", "true");
                        deployBtn.innerText = "REQUESTING...";

                        try {
                            const res = await fetch(
                                `https://api.github.com/repos/${GITHUB_REPO}/dispatches`,
                                {
                                    method: "POST",
                                    headers: {
                                        Accept: "application/vnd.github.v3+json",
                                        Authorization: `token ${GITHUB_TOKEN}`,
                                    },
                                    body: JSON.stringify({
                                        event_type: "publish_event",
                                    }),
                                },
                            );
                            if (res.ok) {
                                alert(
                                    "æ›´æ–°ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¾ã—ãŸï¼\næ•°åˆ†å¾Œã«æœ¬ç•ªã‚µã‚¤ãƒˆãŒæ›´æ–°ã•ã‚Œã¾ã™ã€‚",
                                );
                            } else {
                                throw new Error(`Status: ${res.status}`);
                            }
                        } catch (e) {
                            console.error(e);
                            alert("ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: " + e);
                        } finally {
                            deployBtn.removeAttribute("disabled");
                            deployBtn.innerHTML =
                                '<span class="w-2 h-2 rounded-full bg-accent-blue animate-pulse"></span> PUBLISH SITE';
                        }
                    });
                } else {
                    console.error(
                        "âŒ Firebase Auth not initialized in client context.",
                    );
                }
            };
            document.addEventListener("astro:page-load", initAuth);
        </script>
    </body>
</html>
